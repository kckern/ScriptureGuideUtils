const raw_index_orig = { "Genesis":[31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26],"Exodus":[22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38],"Leviticus":[17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,37,27,24,33,44,23,55,46,34],"Numbers":[54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,41,30,25,18,65,23,31,40,16,54,42,56,29,34,13],"Deuteronomy":[46,37,29,49,33,25,26,20,29,22,32,32,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,68,29,20,30,52,29,12],"Joshua":[18,24,17,24,15,27,26,35,27,43,23,24,33,15,63,10,18,28,51,9,45,34,16,33],"Judges":[36,23,31,24,31,40,25,35,57,18,40,15,25,20,20,31,13,31,30,48,25],"Ruth":[22,23,18,22],"1 Samuel":[28,36,21,22,12,21,17,22,27,27,15,25,23,52,35,23,58,30,24,42,15,23,29,22,44,25,12,25,11,31,13],"2 Samuel":[27,32,39,12,25,23,29,18,13,19,27,31,39,33,37,23,29,33,43,26,22,51,39,25],"1 Kings":[53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,43,29,53],"2 Kings":[18,25,27,44,27,33,20,29,37,36,21,21,25,29,38,20,41,37,37,21,26,20,37,20,30],"1 Chronicles":[54,55,24,43,26,81,40,40,44,14,47,40,14,17,29,43,27,17,19,8,30,19,32,31,31,32,34,21,30],"2 Chronicles":[17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,33,25,33,27,23],"Ezra":[11,70,13,24,17,22,28,36,15,44],"Nehemiah":[11,20,32,23,19,19,73,18,38,39,36,47,31],"Esther":[22,23,15,17,14,14,10,17,32,3],"Job":[22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17],"Psalms":[6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,6,7,23,13,11,11,17,12,8,12,11,10,13,20,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,13,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,176,7,8,9,4,8,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6],"Proverbs":[33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31],"Ecclesiastes":[18,26,22,16,20,12,29,17,18,20,10,14],"Solomon's Song":[17,17,11,16,16,13,13,14],"Isaiah":[31,22,26,6,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,24,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,11,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24],"Jeremiah":[19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,34],"Lamentations":[22,22,66,22,22],"Ezekiel":[28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,63,24,32,14,49,32,31,49,27,17,21,36,26,21,26,18,32,33,31,15,38,28,23,29,49,26,20,27,31,25,24,23,35],"Daniel":[21,49,30,37,31,28,28,27,27,21,45,13],"Hosea":[11,23,5,19,15,11,16,14,17,15,12,14,16,9],"Joel":[20,32,21],"Amos":[15,16,15,13,27,14,17,14,15],"Obadiah":[21],"Jonah":[17,10,10,11],"Micah":[16,13,12,13,15,16,20],"Nahum":[15,13,19],"Habakkuk":[17,20,19],"Zephaniah":[18,15,20],"Haggai":[15,23],"Zechariah":[21,13,10,14,11,15,14,23,17,12,17,14,9,21],"Malachi":[14,17,18,6],"Matthew":[25,23,17,25,48,34,29,34,38,42,30,50,58,36,39,28,27,35,30,34,46,46,39,51,46,75,66,20],"Mark":[45,28,35,41,43,56,37,38,50,52,33,44,37,72,47,20],"Luke":[80,52,38,44,39,49,50,56,62,42,54,59,35,35,32,31,37,43,48,47,38,71,56,53],"John":[51,25,36,54,47,71,53,59,41,42,57,50,38,31,27,33,26,40,42,31,25],"Acts":[26,47,26,37,42,15,60,40,43,48,30,25,52,28,41,40,34,28,41,38,40,30,35,27,27,32,44,31],"Romans":[32,29,31,25,21,23,25,39,33,21,36,21,14,23,33,27],"1 Corinthians":[31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24],"2 Corinthians":[24,17,18,18,21,18,16,24,15,18,33,21,14],"Galatians":[24,21,29,31,26,18],"Ephesians":[23,22,21,32,33,24],"Philippians":[30,30,21,23],"Colossians":[29,23,25,18],"1 Thessalonians":[10,20,13,18,28],"2 Thessalonians":[12,17,18],"1 Timothy":[20,15,16,16,25,21],"2 Timothy":[18,26,17,22],"Titus":[16,15,15],"Philemon":[25],"Hebrews":[14,18,19,16,14,20,28,13,28,39,40,29,25],"James":[27,26,18,17,20],"1 Peter":[25,25,22,19,14],"2 Peter":[21,22,18],"1 John":[10,29,24,21,21],"2 John":[13],"3 John":[14],"Jude":[25],"Revelation":[20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21],"1 Nephi":[20,24,31,38,22,6,22,38,6,22,36,23,42,30,36,39,55,25,24,22,26,31],"2 Nephi":[32,30,25,35,34,18,11,25,54,25,8,22,26,6,30,13,25,22,21,34,16,6,22,32,30,33,35,32,14,18,21,9,15],"Jacob":[19,35,14,18,77,13,27],"Enos":[27],"Jarom":[15],"Omni":[30],"Words of Mormon":[18],"Mosiah":[18,41,27,30,15,7,33,21,19,22,29,37,35,12,31,15,20,35,29,26,36,16,39,25,24,39,37,20,47],"Alma":[33,38,27,20,62,8,27,32,34,32,46,37,31,29,19,21,39,43,36,30,23,35,18,30,17,37,30,14,17,60,38,43,23,41,16,30,47,15,19,26,15,31,54,24,24,41,36,25,30,40,37,40,23,24,35,57,36,41,13,36,21,52,17],"Helaman":[34,14,37,26,52,41,29,28,41,19,38,26,39,31,17,25],"3 Nephi":[30,19,26,33,26,30,26,25,22,19,41,48,34,27,24,20,25,39,36,46,29,17,14,18,6,21,33,40,9,2],"4 Nephi":[49],"Mormon":[19,29,22,23,24,22,10,41,37],"Ether":[43,25,28,19,6,30,27,26,35,34,23,41,31,31,34],"Moroni":[4,3,4,3,2,9,48,30,26,34],"Doctrine and Covenants":[39,3,20,7,35,37,8,12,14,70,30,9,1,11,6,6,9,47,41,84,12,4,7,19,16,2,18,16,50,11,13,5,18,12,27,8,4,42,24,3,12,93,35,6,75,33,4,6,28,46,20,44,7,10,6,20,16,65,24,17,39,9,66,43,6,13,14,35,8,18,11,26,6,7,36,119,15,22,4,5,7,24,6,120,12,11,8,141,21,37,6,2,53,17,17,9,28,48,8,17,101,34,40,86,41,8,100,8,80,16,11,34,10,2,19,1,16,6,7,1,46,9,17,145,4,3,12,25,9,23,8,66,74,12,7,42,10,60],"Moses":[42,31,25,32,59,68,69,30],"Abraham":[31,25,28,31,21],"Joseph Smith\u2014Matthew":[55],"Joseph Smith\u2014History":[75],"Articles of Faith":[13],"Lectures on Faith":[53,359,74,41,44,13,20],"JST Genesis":[33,31,33,13,45,71,84,56,32,20,20,15,15,40,22,20,33,42,44,20,32,28,18,73,34,35,46,22,35,43,55,33,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,28,33,38],"JST Exodus":[22,25,22,31,23,29,25,32,35,29,10,51,22,32,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38],"JST Leviticus":[17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,37,27,24,33,44,23,55,46,34],"JST Numbers":[54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,42,30,25,18,65,23,31,40,16,54,42,56,29,35,13],"JST Deuteronomy":[46,37,29,49,33,25,26,20,29,22,32,33,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,69,29,20,30,52,29,12],"JST Joshua":[18,24,17,24,15,27,26,35,27,43,23,24,33,16,63,10,18,28,51,9,45,34,16,33],"JST Judges":[36,23,31,24,31,40,25,35,57,18,41,15,25,20,20,31,13,31,30,48,25],"JST Ruth":[22,23,18,22],"JST 1 Samuel":[28,36,21,22,12,21,17,22,27,27,15,25,23,53,35,23,58,30,24,42,15,23,29,22,44,26,12,25,11,31,13],"JST 2 Samuel":[27,32,39,12,25,23,29,18,13,19,27,32,39,33,37,23,29,33,43,26,22,51,40,25],"JST 1 Kings":[53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,44,29,53],"JST 2 Kings":[18,25,27,44,27,33,20,29,37,36,21,22,25,29,38,20,41,37,37,21,26,20,37,20,30],"JST 1 Chronicles":[54,55,24,43,26,81,40,40,44,14,47,40,14,18,29,43,27,17,19,8,30,19,33,31,31,32,34,21,30],"JST 2 Chronicles":[17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,34,25,33,27,23],"JST Ezra":[11,70,13,24,17,22,28,36,15,44],"JST Nehemiah":[11,20,32,23,19,19,73,18,38,39,36,48,31],"JST Esther":[22,23,15,17,14,14,10,17,32,3],"JST Job":[22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17],"JST Psalms":[6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,7,7,23,13,11,11,17,12,8,12,11,10,13,19,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,14,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,198,7,8,9,4,6,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6],"JST Proverbs":[33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31],"JST Ecclesiastes":[18,26,22,16,20,12,29,17,18,20,10,15],"JST Isaiah":[31,22,27,5,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,32,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,8,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24],"JST Jeremiah":[19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,35],"JST Lamentations":[22,22,66,22,22],"JST Ezekiel":[28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,64,24,32,14,49,32,31,49,27,17,21,36,26,22,26,18,32,33,31,15,38,28,23,29,49,27,20,27,31,25,24,23,35],"JST Daniel":[21,49,30,37,31,28,28,27,27,21,46,13],"JST Hosea":[11,23,5,19,15,11,16,14,17,15,12,14,16,9],"JST Joel":[20,32,21],"JST Amos":[15,16,15,13,27,14,17,14,15],"JST Obadiah":[21],"JST Jonah":[17,10,10,11],"JST Micah":[16,13,12,13,15,16,20],"JST Nahum":[15,13,19],"JST Habakkuk":[17,20,19],"JST Zephaniah":[18,15,20],"JST Haggai":[15,23],"JST Zechariah":[21,13,10,14,11,15,14,23,17,12,17,14,9,21],"JST Malachi":[14,17,18,6],"JST Matthew":[5,8,46,24,50,39,37,35,44,38,30,44,60,30,37,31,26,34,30,34,56,44,41,56,47,76,67,19],"JST Mark":[40,27,30,33,35,58,36,44,50,54,36,50,61,82,51,21],"JST Luke":[79,52,45,44,39,49,50,55,62,43,55,68,36,38,32,36,40,43,48,47,38,71,57,52],"JST John":[51,25,36,56,48,71,53,59,41,42,58,50,38,31,27,33,26,40,42,31,25],"JST Acts":[26,47,26,37,42,15,60,40,43,48,31,25,52,28,41,40,34,28,41,38,40,30,36,27,27,32,44,31],"JST Romans":[32,29,31,25,21,23,27,39,33,21,36,21,14,23,32,27],"JST 1 Corinthians":[31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24],"JST 2 Corinthians":[24,17,18,18,21,18,16,24,15,18,33,21,14],"JST Galatians":[24,21,29,31,26,18],"JST Ephesians":[23,22,21,32,33,24],"JST Philippians":[30,30,21,23],"JST Colossians":[29,22,25,18],"JST 1 Thessalonians":[10,20,13,18,28],"JST 2 Thessalonians":[12,17,18],"JST 1 Timothy":[20,15,16,16,25,21],"JST 2 Timothy":[18,26,17,22],"JST Titus":[16,15,15],"JST Philemon":[25],"JST Hebrews":[14,18,19,16,14,20,27,13,28,39,40,29,25],"JST James":[27,25,18,17,20],"JST 1 Peter":[25,25,22,19,14],"JST 2 Peter":[21,22,18],"JST 1 John":[10,29,24,21,21],"JST 2 John":[13],"JST 3 John":[14],"JST Jude":[25],"JST Revelation":[20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21],"1 Esdras": [58,30,24,63,73,34,15,96,55],"2 Esdras": [40,48,36,52,56,59,70,63,47,59,46,51,58,48,63,78],"Additions to Esther": [13,12,6,18,19,16,24],"1 Maccabees": [64,70,60,61,68,63,50,32,73,89,74,53,53,49,41,24],"2 Maccabees": [36,32,40,50,27,31,42,36,29,38,38,45,26,46,39],"Tobit": [22,14,17,21,22,17,18,21,6,12,19,22,18,15],"Judith": [16,28,10,15,24,21,32,36,14,23,23,20,20,19,13,25],"Wisdom of Solomon": [16,24,19,20,23,25,30,21,18,21,26,27,19,31,19,29,21,25,22],"Ecclesiasticus": [30,18,31,31,15,37,36,19,18,31,34,18,26,27,20,30,32,33,30,32,28,27,28,34,26,29,30,26,28,25,31,24,31,26,20,26,31,34,35,30,24,25,33,22,26,20,25,25,16,29,30],"Baruch": [22,35,37,37,9],"Epistle of Jeremiah": [73], "Prayer of Azariah": [68] ,"Susanna": [64],"Bel and the Dragon": [42],"Prayer of Manasseh":[14]}


;
const raw_regex_orig = {
    "books":[
        ["gen\\.*(?:e*sis)*", "Genesis"],
        ["exo*\\.*(?:dus)*", "Exodus"],
        ["levi*t*\\.*(?:icus)*", "Leviticus"],
        ["num\\.*(?:bers)*", "Numbers"],
        ["deut\\.*(?:eronomy)*", "Deuteronomy"],
        ["josh\\.*(?:ua)*", "Joshua"],
        ["judg\\.*(?:es)*", "Judges"],
        ["rut*h*\\.*", "Ruth"],
        ["sam*u*\\.*(?:el)*", "Samuel"],
        ["ki*n*gs*\\.*", "Kings"],
        ["chr*o*n*\\.*(?:icles)*", "Chronicles"],
        ["ezr*\\.*(?:a)*", "Ezra"],
        ["neh\\.*(?:emiah)*", "Nehemiah"],
        ["esth*\\.*(?:er)*", "Esther"],
        ["job", "Job"],
        ["ps\\.*(?:a)*\\.*(?:lm)*\\.*(?:s)*", "Psalms"],
        ["prov\\.*(?:erbs)*", "Proverbs"],
        ["eccl*\\.*(?:esiastes)*", "Ecclesiastes"],
        ["(the )*song*\\.*(?: *of *solomon)*", "Solomon's Song"],
        ["isa\\.*(?:iah)*", "Isaiah"],
        ["jer\\.*(?:emiah)*", "Jeremiah"],
        ["lame*n*t*\\.*(?:ations)*", "Lamentations"],
        ["eze*k*\\.*(?:iel)*", "Ezekiel"],
        ["dan\\.*(?:iel)*", "Daniel"],
        ["hos*\\.*(?:ea)*", "Hosea"],
        ["joel*\\.*", "Joel"],
        ["amos*\\.*", "Amos"],
        ["obad\\.*(?:iah)*", "Obadiah"],
        ["jon*\\.*(?:ah)*", "Jonah"],
        ["mic*\\.*(?:ah)*", "Micah"],
        ["nah*\\.*(?:um)*", "Nahum"],
        ["hab*\\.*(?:akuk)*", "Habakkuk"],
        ["zeph*\\.*(?:aniah)*", "Zephaniah"],
        ["hag\\.*(?:gai)*", "Haggai"],
        ["zech*\\.*(?:ariah)*", "Zechariah"],
        ["mal*\\.*(?:achi)*", "Malachi"],
        
        ["(?:mat*t*h*|mt)\\.*(?:ew)*", "Matthew"],
        ["m(ar)*k", "Mark"],
        ["lu*k*e*\\.*", "Luke"],
        ["jo*h*n\\.*", "John"],
        ["(?:the )*act*s*\\.*(?: of the apostles)*", "Acts"],
        ["rom*\\.*(?:ans)*", "Romans"],
        ["cor\\.*(?:inthians)*", "Corinthians"],
        ["gal*a*\\.*(?:tians)*", "Galatians"],
        ["ephe*\\.*(?:sians)*", "Ephesians"],
        ["phili*p*\\.*(?:ippians)*", "Philippians"],
        ["colo*s*\\.*(?:sians)*", "Colossians"],
        ["thess*\\.*(?:alonians)*", "Thessalonians"],
        ["tim\\.*(?:othy)*", "Timothy"],
        ["tit*\\.*(?:us)*", "Titus"],
        ["philem*o*n*\\.*", "Philemon"],
        ["he\\.*(?:b)*\\.*(?:rews)*", "Hebrews"],
        ["ja\\.*(?:me)*s", "James"],
        ["pet*\\.*(?:er)*", "Peter"],
        ["ju\\.*(?:d)*\\.*(?:e)*", "Jude"],
        ["rev\\.*(?:elation)*", "Revelation"],


        ["1\\s*esd\\.*(?:ras)*", "1 Esdras"],
        ["2\\s*esd\\.*(?:ras)*", "2 Esdras"],
        ["add\\.*to\\.*esth\\.*", "Additions to Esther"],
        ["1\\s*mac\\.*(?:cabees)*", "1 Maccabees"],
        ["2\\s*mac\\.*(?:cabees)*", "2 Maccabees"],
        ["tob\\.*", "Tobit"],
        ["jud\\.*(?:ith)*\\s", "Judith"],
        ["wisdom(of\\ssolomon)*", "Wisdom of Solomon"],
        ["ecclesiasticus", "Ecclesiasticus"],
        ["sirach", "Ecclesiasticus"],
        ["baruch", "Baruch"],
        ["bar*\\.*(?:uch)*", "Baruch"],
        ["epistle\\s*of\\s*jeremiah", "Epistle of Jeremiah"],
        ["letter\\s*of\\s*jeremiah", "Epistle of Jeremiah"],
        ["(prayer\\s*of\\s*)*azariah","Prayer of Azariah"],
        ["sus\\.*(?:anna)*", "Susanna"],
        ["bel\\.*", "Bel and the Dragon"],
        ["bel\\s*(and\\s*)*dragon", "Bel and the Dragon"],
        ["(prayer\\s*of\\s*)*manasseh", "Prayer of Manasseh"],

        
        ["ne\\.*(?:phi)*", "Nephi"],
        ["jac\\.*(?:ob)*", "Jacob"],
        ["en\\.*(?:os)*", "Enos"],
        ["jar\\.*(?:om)*", "Jarom"],
        ["om\\.*(?:ni)*", "Omni"],
        ["(?:the *)*w(?:ords)*[ _-]*o[ _-f]*m(?:ormon)*", "Words of Mormon"],
        ["mos\\.*(?:iah)*", "Mosiah"],
        ["alma", "Alma"],
        ["hela*\\.*(?:a*man)*", "Helaman"],
        ["eth\\.*(?:er)*", "Ether"],
        ["morm\\.*(?:on)*", "Mormon"],
        ["moro\\.*(?:ni)*", "Moroni"],
        
        ["d(?:octrine)*\\.* *(?:&amp;|&|and)* *c(?:ovenants)*(?:\\s*\\bSec(?:tion)*)*\\.*", "Doctrine and Covenants"],
        ["dee and see", "Doctrine and Covenants"], 
        
        ["moses", "Moses"],
        ["Abra*\\.*(?:ham)*", "Abraham"],
        ["Jos(?:eph)*\\.* Smith(?:[–—\\- ]+Matthew)", "Joseph Smith\u2014Matthew"],
        ["Jos(?:eph)*\\.* Smith(?:[–—\\- ]+History)", "Joseph Smith\u2014History"],
        ["JS[—\\-]*\\s*[H]", "Joseph Smith\u2014History"],
        ["JS[—\\-]*\\s*[M]", "Joseph Smith\u2014Matthew"],
        ["a(?:rticles)*[ _-]*o[ _-f]*f(?:aith)*", "Articles of Faith"],
        
        [",* *jst", "JST"], 
        ["Jos(eph)*\\.* Smith('s)* Translation,*( of)*\\s*", "JST"], 
        ["([^;-]*?)\\s*jst\\s*", "JST $1"], 
        ["JST *,*[ —-]+", "JST "], 
        ["JST Genesis 0", "Moses 1"],
        ["lect*(?:ures*)*(?: on faith)*\\.*", "Lectures on Faith"],
        ["l[ _-]*o*[ _-n]*f", "Lectures on Faith"],
        ["bo*c\\s*(\\d+)", "Book of Commandments $1"],
        ["(?:book of )*com(?:mandments)*", "Book of Commandments"],
        ["l *on* *f", "Lectures on Faith"],
        ["lec\\.*(?:tures*)(?: on faith)*", "Lectures on Faith"],
        
        ["(?:the )*(?:book of )*(?:the )*Law of the Lord", "Law"],
        ["Law", "The Law of the Lord"],
        
        ["tsp", "The Sealed Portion"],
        ["the sealed portion", "The Sealed Portion"],
        ["1\\s*(?:st)*\\s*v(?:ision)*", "First Vision"],
        
        ["W\\s*Moroni", "Words of Moroni"],
        ["Sealed Book of Moses", "The Sealed Book of Moses"],
        ["Acts of the Three Nephites", "The Acts of the Three Nephites"],
        
        ["qur['’ ]*(an)*", "Qur’an"],
        ["(?:al[ \\-––])*qur'*’*ani*c*(?:verses*)*", "Qur’an"],
        ["surah [a-z\\-–’']*(?: |:|–|\\-|v|vv|verses*)*", "Qur’an"],
        ["al[ \\-–][a-z\\-–’']+(?: |:|–|\\-|v|vv|verses*|ayab)*", "Qur’an"],
        ["kor(an)*", "Qur’an"],
        
        ["dh*p(ada)*", "Dhammapada"],
        ["d(ha|ah)mm*(apada)*", "Dhammapada"],
        ["b*h*(agavad)* *g(ita)*", "Bhagavad Gita"],
        ["tao( *te* *ching)*", "Tao Te Ching"],
        
        
        ["(Book of )+", "Book of "],
        ["( on Faith)+", " on Faith"],
        ["(Solomon's )+", "Solomon's "]
    ],
    "pre_rules":[

        ["[.]{2,}", ";"],
        ["(\\d+) (\\d+)", "$1.$2"],
        ["([0-9])[.]\\s*([0-9])", "$1:$2"],
        ["([a-z])[ .-]*0+", "$1"],
        ["^(\\d+)-", "$1"],
        [" "," "],

        ["(first|1st|\\bi\\b)", "1"],
        ["(second|2nd|\\bii\\b)", "2"],
        ["(third|3rd|\\biii\\b)", "3"],
        ["(fourth|4th|\\biv\\b)", "4"],
        ["([0-9])th\\b", "$1"],
        ["([1-4])(st|nd|d|rd|th)\\b", "$1"],
        [",*\\s*\\b(?:ch\\b|chap(?:t*er)*s*)\\.*\\,*\\s*(\\d+)", "$1"],
        [",*\\s*\\b(?:sec\\b|section)\\.*\\s*(\\d+)", "$1"],
        ["([0-9]),*\\s*\\b(?:chapt*ers*|ch|chptrs*)\\.*,*\\s*([0-9])", "$1:$2"],
        ["([a-z]),*\\s*\\b(?:chapt*ers*|ch|chptrs*)\\s*([0-9])", "$1 $2"],
        ["[()]+", " "],  
        ["[\\s.]*[–—−\\-]+[\\s.]*", "-"], 
        ["&ndash;", "-"],
        ["([;,])\\s*and\\s*", "$1"],
        ["([0-9])[ .]*and[ .]*", "$1,"],
        ["(\\d)(\\.|: )(\\d)", "$1:$3"],
        ["\\s+(\\d+)[-–—](\\d+:\\d+)", " $1:1-$2"],
        ["(\\d)([A-Z])", "$1 $2"],
        ["(\\d) ([A-Z])$", "$1$2"],
        ["([0-9]),\\s*([1-4]*\\s*[a-z])", "$1; $2"],
        ["([a-z]), ([0-9])", "$1 $2"],  
        ["\\.", " "],  
        [" - ", " "],  
        ["; ", ";"],  
        [": ", ":"],  
        ["(\\D)-(\\d)", "$1 $2"],  
        ["([a-z]),", "$1"],  
        ["jst(,| of )", "JST "],  
        ["jst([a-z])", "JST $1"],  
        [",\\s*((?:\\d+\\s)*[a-z])", "; $1"],
        ["\\bv*ve*r*s*e*s*\\s*([0-9])", ":$1"],
        ["(, *)*\\bverses*\\s*([0-9])", ":$1"],
        ["\\s*:", ":"],  
        [";\\s*:", ":"],
        ["(\\d+) *to *(\\d+)", "$1-$2"], 
        ["([—-])h", "\u2014H"],
        ["([—-])m", "\u2014M"],
        ["([A-za-z])(\\d)", "$1 $2"],
        ["([0-9]),\\s*([1-4]*\\s*[a-z])", "$1; $2"],
        ["o([nf])", "o$1"],
        ["([;,])", "$1 "],
        ["(the )*book of", ""],
        [",\\s*([0-9]+)\\s*:", "; $1:"],
        ["\\b\\s*cf[:.]*\\s*\\b", " "]
    ],

    "post_rules":[
        ["(Words of Mormon|Articles of Faith|4 Nephi|Jarom|Enos|Omni|Obadiah|2 John|3 John|Philemon|Jude|First Vision|Joseph Smith—.+)\\s+([2-9]|(\\d\\d+))","$1 1:$2"],
        ["(^|;\\s*)(Nephi|cor|kings|chron|thes|pet|tim)","$1 1 $2"],
        ["\\s+"," "],
        ["([a-z]\\s*\\d+)(-\\d+:\\d+)","$1:1$2"],
        ["--","\u2014"]
    ]
};
const raw_lang = {
    ko:{
        spacing: ["", " "],
        books:{ "창세기": ["창"], "출애굽기": ["출", "탈출기"], "레위기": ["레"], "민수기": ["민"], "신명기": ["신"], "여호수아": ["수"], "사사기": ["삿", "판관기"], "룻기": ["룻"], "사무엘상": ["삼상"], "사무엘하": ["삼하"], "열왕기상": ["왕상"], "열왕기하": ["왕하"], "역대상": ["대상", "역대기 *상"], "역대하": ["대하", "역대기 *하"], "에스라": ["스", "에즈라"], "느헤미야": ["느"], "에스더": ["에", "에스텔"], "욥기": ["욥"], "시편": ["시"], "잠언": ["잠"], "전도서": ["전", "코헬렛"], "아가": ["아"], "이사야": ["사", "이사야서"], "예레미야": ["렘", "예레미야서"], "예레미야애가": ["애"], "에스겔": ["겔", "에제키엘"], "다니엘": ["단", "다니엘서"], "호세아": ["호", "호세아서"], "요엘": ["욜", "요엘서"], "아모스": ["암", "아모스서"], "오바댜": ["옵", "오바댜서", "오바디야"], "요나": ["욘", "요나서"], "미가": ["미", "미가서"], "나훔": ["나", "나훔서"], "하박국": ["합", "[하합]박[꾹국]서*"], "스바냐": ["습", "스바니야"], "학개": ["학", "하깨"], "스가랴": ["슥", "즈가리야"], "말라기": ["말", "말라기서"], "마태복음": ["마", "마태", "마태오 복음서", "마태오의 복음서"], "마가복음": ["막", "마가", "마르코 복음서"], "누가복음": ["눅","[루누][가카]","[루누][가카] *복음서*"], "요한복음": ["요", "요한", "요한 *복음서*"], "사도행전": ["사*도*행전*","악"], "로마서": ["롬", "로마인들에게 보낸 편지"], "고린도전서": ["고전", "코린토1서"], "고린도후서": ["고후", "코린토2서"], "갈라디아서": ["갈"], "에베소서": ["엡", "에페소인들에게 보낸 편지"], "빌립보서": ["빌", "필리피서"], "골로새서": ["골", "콜로새서"], "데살로니가전서": ["살전", "테살로니카1서"], "데살로니가후서": ["살후", "테살로니카2서"], "디모데전서": ["딤전", "티모테오1서"], "디모데후서": ["딤후", "티모테오2서", "티모테후서"], "디도서": ["딛", "티토서"], "빌레몬서": ["몬", "필레몬서"], "히브리서": ["히"], "야고보서": ["약"], "베드로전서": ["베드로 전서","벧전", "베드로1서"], "베드로후서": ["베드로 후서", "벧후", "베드로2서"], "요한일서": ["요1", "요(일|1)", "(일|1)요"], "요한이서": ["요2", "요(이|2)", "(이|2)요"], "요한삼서": ["요3", "요(삼|3)", "(삼|3)요"], "유다서": ["유다*", "유다의 편지"], "요한 계시록": ["계시*록*", "요한 *[묵계]시록"], "니파이전서": ["니전"], "니파이후서": ["니후"], "야곱서": ["야곱"], "이노스서": ["이노", "이노스서"], "예이롬서": ["예이", "예이롬"], "옴나이서": ["옴", "옴나이"], "몰몬의 말씀": ["몰말", "몰몬말씀"], "모사이야서": ["모사", "모사이야"], "앨마서": ["앨", "앨마"], "힐라맨서": ["힐", "힐라맨"], "제3니파이": ["3니", "제* *3 *니파이서*"], "제4니파이": ["4니", "제* *4 *니파이서*"], "몰몬서": ["몰", "몰몬"], "이더서": ["이더"], "모로나이서": ["모로", "모로나이"], "교리와 성약": ["교성", "교리성약"], "모세서": ["모세"], "아브라함서": ["아브", "아브라함"], "조셉 스미스—마태복음": ["조마", "조셉 스미스—마태"], "조셉 스미스—역사": ["조역", "조셉 스미스—역사"], "신앙개조": ["신개"] },
        pre_rules: [
            //handle 1장 2절-3절
            //turn 30 장 10 절 into 30장 10절
            ["부터", "-"],
            ["(\\d+)\\s*장\\s*(\\d+)(?:~|-)(\\d+)\\s*절*", "$1:$2-$3"],
            ["(비교|또는*|그리고|과|와|및)", ";"],
            //handle 1장 2절
            ["(\\d+)\\s*장\\s*(\\d+)\\s*절*", "$1:$2"],
            ["~", "-"],
            ["(\\d+)\\s*장", "$1"],
            ["(\\d+)\\s*절", "$1"],
            ["([\\u3131-\\uD79D]) *(\\d+)", "$1 $2"],
            ["제 (\\d)", "제$1"],
            ["조셉 스미스[—-]", "조셉 스미스—"],
            [", *([^0-9])", ";  $1"],
        ],
        post_rules: [
            ["([\\u3131-\\uD79D]) *([0-9]+)", "$1 $2장 "],
            ["([0-9]+):([0-9]+)-([0-9]+)", "$1장 $2~$3절"],
            ["[–-]+", "~"],
            ["\\s*:\\s*([0-9~]+)", ":$1절"],
            ["([0-9]+):([0-9]+)", "$1장$2"],
            ["장:([0-9]+)", "장 $1"],
            [";", "; "],
            ["\\s+", " "],
            ["제\\s*([3-4])장\\s*니파이", "제$1니파이"],
            ["([0-9]+)장\\s*([0-9]+)", "$1장 $2"]
            
        ],
        matchRules:{
            book: "(제[0-9]+)*",
            chapter:"([장절과와및0-9:;,~\\s—–-]|부터|그리고|또는*)*[0-9장절]+",
            verse:"절",
            joiners: ["^[;, ]*(또는*|그리고|비교|과|와)*$"],
            tail: "[^장절0-9]+$"
        },
    },
    de:{
        books:
        {
            "Genesis": ["gen","1\\.* *(buch )*mose"],  "Exodus":["ex","2\\.* *(buch )*mose"], "Leviticus":["lev","3\\.* *(buch )*mose"], "Numbers":["num","4\\.* *(buch )*mose"], "Deuteronomy":["dtn","5\\.* *(buch )*mose"], "Josua":["jos"], "Richter":["ri"], "Rut":["rut"], "1 Samuel":["1 sam"], "2 Samuel":["2 sam"], "1 Könige":["1 kön"], "2 Könige":["2 kön"], "1 Chronik":["1 chr"], "2 Chronik":["2 chr"], "Esra":["esra"], "Nehemia":["neh"], "Ester":["est"], "Ijob":["iob"], "Psalmen":["ps"], "Sprichwörter":["spr"], "Kohelet":["koh"], "Hohelied":["hld"], "Jesaja":["jes"], "Jeremia":["jer"], "Klagelieder":["klgl"], "Ezechiel":["ez"], "Daniel":["dan"], "Hosea":["hos"], "Joël":["joe"], "Amos":["am"], "Obadja":["obd"], "Jona":["jon"], "Micha":["mi"], "Nahum":["nah"], "Habakuk":["hab"], "Zefanja":["zef"], "Haggai":["hag"], "Sacharja":["sach"], "Maleachi":["mal"], "Matthäus":["mt"], "Markus": ["mk"], "Lukas": ["lk"], "Johannes": ["joh"], "Apostelgeschichte": ["apg"], "Römer": ["röm"], "1 Korinther": ["1 kor"], "2 Korinther": ["2 kor"], "Galater": ["gal"], "Epheser": ["eph"], "Philipper": ["phil"], "Kolosser": ["kol"], "1 Thessalonicher": ["1 thess"], "2 Thessalonicher": ["2 thess"], "1 Timotheus": ["1 tim"], "2 Timotheus": ["2 tim"], "Titus": ["tit"], "Philemon": ["phlm"], "Hebräer": ["hebr"], "Jakobus": ["jakbr"], "1 Petrus": ["1 petr"], "2 Petrus": ["2 petr"], "1 Johannes": ["1 joh"], "2 Johannes": ["2 joh"], "3 Johannes": ["3 joh"], "Judas": ["jud"], "Offenbarung": ["offb"], "1 Nephi": ["1 ne"], "2 Nephi": ["2 ne"], "Jakob": ["jak"], "Enos": ["enos"], "Jarom": ["jar"], "Omni": ["om"], "Worte Mormons": ["wmorm"], "Mosia": ["mos"], "Alma": ["al"], "Helaman": ["hel"], "3 Nephi": ["3 ne"], "4 Nephi": ["4 ne"], "Mormon": ["morm"], "Ether": ["eth"], "Moroni": ["moro"], "Lehre und Bündnisse": ["lub"], "Mose": ["mose"], "Abraham": ["abr"], "Joseph Smith—Matthäus": ["jsmt"], "Joseph Smith—Lebensgeschichte": ["jslg"], "Glaubensartikel": ["ga"]
        }
    },
    swe:{
        books:{
            "1 Moseboken": ["1 mos"], "2 Moseboken": ["2 mos"], "3 Moseboken": ["3 mos"], "4 Moseboken": ["4 mos"], "5 Moseboken": ["5 mos"], "Josua": ["jos"], "Domarboken": ["dom"], "Rut": ["rut"], "1 Samuelsboken": ["1 sam"], "2 Samuelsboken": ["2 sam"], "1 Kungaboken": ["1 kung"], "2 Kungaboken": ["2 kung"], "1 Krönikeboken": ["1 krön"], "2 Krönikeboken": ["2 krön"], "Esra": ["esra"], "Nehemja": ["neh"], "Ester": ["est"], "Job": ["job"], "Psaltaren": ["ps"], "Ordspråksboken": ["ords"], "Predikaren": ["pred"], "Höga Visan": ["höga v"], "Jesaja": ["jes"], "Jeremia": ["jer"], "Klagovisorna": ["klag"], "Hesekiel": ["hes"], "Daniel": ["dan"], "Hosea": ["hos"], "Joel": ["joel"], "Amos": ["amos"], "Obadja": ["ob"], "Jona": ["jona"], "Mika": ["mika"], "Nahum": ["nah"], "Habackuk": ["hab"], "Sefanja": ["sef"], "Haggai": ["hagg"], "Sakarja": ["sak"], "Malaki": ["mal"], "Matteus": ["matt"], "Markus": ["mark"], "Lukas": ["luk"], "Johannes": ["joh"], "Apostlagärningarna": ["apg"], "Romarbrevet": ["rom"], "1 Korintierbrevet": ["1 kor"], "2 Korintierbrevet": ["2 kor"], "Galaterbrevet": ["gal"], "Efesierbrevet": ["ef"], "Filipperbrevet": ["fil"], "Kolosserbrevet": ["kol"], "1 Tessalonikerbrevet": ["1 tess"], "2 Tessalonikerbrevet": ["2 tess"], "1 Timoteusbrevet": ["1 tim"], "2 Timoteusbrevet": ["2 tim"], "Titus": ["tit"], "Filemon": ["filem"], "Hebreerbrevet": ["hebr"], "Jakobs brev": ["jak"], "1 Petrusbrevet": ["1 petr"], "2 Petrusbrevet": ["2 petr"], "1 Johannesbrevet": ["1 joh"], "2 Johannesbrevet": ["2 joh"], "3 Johannesbrevet": ["3 joh"], "Judas": ["jud"], "Uppenbarelseboken": ["upp"], "1 Nephi": ["1 ne"], "2 Nephi": ["2 ne"], "Jakob": ["jak"], "Enos": ["enos"], "Jarom": ["jar"], "Omni": ["om"], "Mormons ord": ["morm ord"], "Mosiah": ["mos"], "Alma": ["al"], "Helaman": ["hel"], "3 Nephi": ["3 ne"], "4 Nephi": ["4 ne"], "Mormon": ["morm"], "Ether": ["eth"], "Moroni": ["moro"], "Läran och förbunden": ["l&f"],  "Mose": ["mose"], "Abraham": ["abr"], "Joseph Smith – Matteus": ["js-m"], "Joseph Smith – Historien": ["js-h"], "Trosartiklarna": ["ta"]
        }
    },
    ru:{
        books:{
            "Бытие": ["Быт"], "Исход": ["Исх"], "Левит": ["Лев"], "Числа": ["Числ"], "Второзаконие": ["Втор"], "Иисус Навин": ["Нав"], "Книга Судей": ["Суд"], "Руфь": ["Руфь"], "1я Царств": ["1[яек]* Цар"], "2я Царств": ["2[яек-]* Цар"], "3я Царств": ["3[яек]* Цар"], "4-я Царств": ["4 Цар"], "1я Паралипоменон": ["1[яек]* Пар"], "2я Паралипоменон": ["2[яек-]* Пар"], "Ездра": ["Езд"], "Неемия": ["Неем"], "Есфирь": ["Есф"], "Иов": ["Иов"], "Псалтирь": ["Пс"], "Притчи": ["Притч"], "Екклесиаст": ["Еккл"], "Песня Песней": ["Песн"], "Исаия": ["Ис"], "Иеремия": ["Иер"], "Плач Иеремии": ["Плач"], "Иезекииль": ["Иез"], "Даниил": ["Дан"], "Осия": ["Ос"], "Иоиль": ["Иоиль"], "Амос": ["Ам"], "Авдий": ["Авд"], "Иона": ["Иона"], "Михей": ["Мих"], "Наум": ["Наум"], "Аввакум": ["Авв"], "Софония": ["Соф"], "Аггей": ["Агг"], "Захария": ["Зах"], "Малахия": ["Мал"], "От Матфея": ["Мф"], "От Марка": ["Мк"], "От Луки": ["Лк"], "От Иоанна": ["Ин"], "Деяния": ["Деян"], "К Римлянам": ["Рим"], "1е к Коринфянам": ["1[яек]* Кор"], "2е к Коринфянам": ["2[яек]* Кор"], "К Галатам": ["Гал"], "К Ефесянам": ["Еф"], "К Филиппийцам": ["Флп"], "К Колоссянам": ["Кол"], "1е к Фессалоникийцам": ["1[яек]* Фес"], "2е к Фессалоникийцам": ["2[яек]* Фес"], "1е к Тимофею": ["1[яек]* Тим"], "2е к Тимофею": ["2[яек]* Тим"], "К Титу": ["Тит"], "К Филимону": ["Флм"], "К Евреям": ["Евр"], "Иакова": ["Иакова"], "1е Петра": ["1[яек]* Пет"], "2е Петра": ["2[яек]* Пет"], "1е Иоанна": ["1[яек]* Ин"], "2е Иоанна": ["2[яек]* Ин"], "3е Иоанна": ["3[яек]* Ин"], "Иуды": ["Иуд"], "Откровение": ["Откр"], "1 Нефий": ["1[яек]* Неф"], "2 Нефий": ["2[яек]* Неф"], "Енос": ["Енос"], "Иаром": ["Иаром"], "Омний": ["Омний"], "Слова Мормона": ["Сл М"], "Мосия": ["Мосия"], "Алма": ["Алма"], "Геламан": ["Гел"], "3 Нефий": ["3[яек]* Неф"], "4 Нефий": ["4 Неф"], "Мормон": ["Морм"], "Ефер": ["Ефер"], "Мороний": ["Морон"], "Учение и Заветы": ["У и З"], "Моисей": ["Моис"], "Авраам": ["Авр"], "Джозеф Смит – от Матфея": ["ДжС–Мф"], "Джозеф Смит – История": ["ДжС–Ист"], "Символы веры": ["С В"]
        },
        pre_rules: [
            ["([1-3])[ –-]*([яек])", "$1$2"],
            ["p", "р"],
        ],
        post_rules: [
            ["([1-3])-*([ея])", "$1-$2"],

        ]
    },
    vn:{
        pre_rules: [
            //replace dashes in book names with spaces
            ["-([^0-9 ])", " $1"],
            [", *([^0-9])", ";  $1"],
            ["(hoặc|và|so với)", "; "],
            [";\\s*Giao", "và Giao"],
        ],
        books:{
            "Sáng Thế": ["STK[yý]", "Sáng Thế Ký","S[áa]ng *Th[ếe] *(K[yý])*"], "Xuất Ê Díp Tô": ["X[ÊE]DT(K[ýy])*","X[úu]at *Ê *D[íi]p *T[ôo] *(K[yý])*","Xu[ấa]t h[àa]nh *(k[yý])*"], "Lê Vi": ["L[êe] *Vi *(K[yý])*","LV(K[ýy])*"], "Dân Số": ["DS(K[yý])*","D[âa]n *S[ốo] *(K[yý])*"], "Phục Truyền Luật Lệ": ["PTLL(K[yý])*","Ph[úu]c *Truy[ềe]n *Lu[ậa]t *L[ệe] *(K[yý])*"], "Giô Suê": ["Gi[ôo] *Su[êe]"], "Các Quan Xét": ["C[áa]c *Quan *X[ée]t","QX[ée]t"], "Ru Tơ": ["Ru *T[ơo]"], "1 Sa Mu Ên": ["1 *Sa *Mu *Ên","1 *SM[EÊ]n"], "2 Sa Mu Ên": ["2 *Sa *Mu *Ên","2 *SM[EÊ]n"], "1 Các Vua": ["1 *C[áa]c *Vua","1 *Vua"], "2 Các Vua": ["2 *C[áa]c *Vua","2 *Vua"], "1 Sử Ký": ["1 *S[ửu] *K[yý]"], "2 Sử Ký": ["2 *S[ửu] *K[yý]"], "E Xơ Ra": ["E *X[ơo] *Ra"], "Nê Hê Mi": ["N[êe] *H[êe] *Mi"], "Ê Xơ Tê": ["Ê *X[ơo] *T[êe]"], "Gióp": ["Gi[óo]p"], "Thi Thiên": ["Th*i* *Thi[êe]n"], "Châm Ngôn": ["Ch[âa]m *Ng[ôo]n","CNg[ôo]n"], "Truyền Đạo": ["T[DĐ][aạ]o","Truy[ềe]n *[ĐD]a[ọo]"], "Nhã Ca": ["Nh[ãa] *Ca"], "Ê Sai": ["[ÊE] *Sai"], "Giê Rê Mi": ["GRMi","Gi[êe] *R[êe] *Mi"], "Ca Thương": ["CTh[uư][oơ]ng","Ca *Th[ưu]ng"], "Ê Xê Chi Ên": ["[EÊ]XC[EÊ]n","Ê *X[êe] *Chi *[ÊE]n"], "Đa Ni Ên": ["[DĐ]N[EÊ]n","[ĐD]a *Ni *[ÊE]n"], "Ô Sê": ["[ÔO] *S[êe]"], "Giô Ên": ["Gi[ôo] *[ÊE]n"], "A Mốt": ["A *M[ốo]t"], "Áp Đia": ["[ÁA]p *Đia"], "Giô Na": ["Gi[ôo] *Na"], "Mi Chê": ["Mi *Ch[êe]"], "Na Hum": ["Na *Hum"], "Ha Ba Cúc": ["HBCuc","Ha *Ba *C[úu]c"], "Sô Phô Ni": ["S[ôo]* *Ph*[ôo]* *Ni"], "A Ghê": ["A *Gh[êe]"], "Xa Cha Ri": ["Xa* *Ch*a* *Ri"], "Ma La Chi": ["Ma* *La* *Chi"], "Ma Thi Ơ": ["Ma *Thi *[ƠO]","MT[OƠ]"], "Mác": ["M[áa]c"], "Lu Ca": ["Lu *Ca"], "Giăng": ["Gio*[ăa]ng*"], "Công Vụ Các Sứ Đồ": ["C[ôo]ng *Vụ *C[áa]c *Sứ *Đ[ồo]", "CVCS[ĐD]"], "Rô Ma": ["R[ôo] *Ma"], "1 Cô Rinh Tô": ["1 *C[ôo]* *Ri*n*h* *T[ôo]"], "2 Cô Rinh Tô": ["2 *C[ôo]* *Ri*n*h* *T[ôo]"], "Ga La Ti": ["Ga *La *Ti"], "Ê Phê Sô": ["[ÊE] *Ph[êe] *S[ôo]","[ÊE]PS[ÔO]"], "Phi Líp": ["Phi *L[íi]p"], "Cô Lô Se": ["C[ôo] *L[ôo] *Se","CL[ÔO]*Se"], "1 Tê Sa Lô Ni Ca": ["1 *Tê *Sa *L[ôo] *Ni *Ca","1 *TSLN[ÔO]Ca","1 TSLNCa"], "2 Tê Sa Lô Ni Ca": ["2 TSLNCa","2 *Tê *Sa *L[ôo] *Ni *Ca","2 *TSLN[ÔO]Ca"], "1 Ti Mô Thê": ["1 *Ti *Mô *Th[êe]","1 *TMTh[ÊE]"], "2 Ti Mô Thê": ["2 *Ti *Mô *Th[êe]","2 *TMTh[ÊE]"], "Tít": ["T[íi]t"], "Phi Lê Môn": ["Phi *L[êe] *Môn","PL[ÊE]M[ÔO]n","PLM[oô]n"], "Hê Bơ Rơ": ["H[êe] *Bơ *Rơ","HBR[ƠO]"], "Gia Cơ": ["GLTi", "Gia *C[ơo]"], "1 Phi E Rơ": ["1 *Phi *E *R[ơo]","1 *PER[ƠO]"], "2 Phi E Rơ": ["2 *Phi *E *R[ơo]","2 *PER[ƠO]"], "1 Giăng": ["1 *Gio*[ăa]ng*"], "2 Giăng": ["2 *Gio*[ăa]ng*"], "3 Giăng": ["3 *Gio*[ăa]ng*"], "Giu Đe": ["Giu *[ĐD]e"], "Khải Huyền": ["Kh[ảa]i *Huy[ềe]n","KHuy[ềe]n"], "1 Nê Phi": ["1 *N[êe] *Phi"], "2 Nê Phi": ["2 *N[êe] *Phi"], "Gia Cốp": ["Gi*a* *C[ốo]p"], "Ê Nót": ["[ÊE] *N[óo]t"], "Gia Rôm": ["Gi*a* *R[ôo]m"], "Ôm Ni": ["[ÔO]m *Ni"], "Lời Mặc Môn": ["L[ờo]i *M[ặa]c *M[ôo]n","LMM[ÔO]n"], "Mô Si A": ["M[ôo] *Si *A"], "An Ma": ["An *Ma"], "Hê La Man": ["H[êe]* *La* *Man"], "3 Nê Phi": ["3 *N[êe] *Phi"], "4 Nê Phi": ["4 *N[êe] *Phi"], "Mặc Môn": ["M[ậa]c *M[ôo]n", "MM[ÔO]n"], "Ê The": ["[ÊE] *The"], "Mô Rô Ni": ["M[ôo] *R[ôo] *Ni","MRN[ÎI]"], "Giáo Lý và Giao Ước": ["Gi[áa]o *L[ýi] *v[àa] *Giao *[ƯU][ớo]c","GLG[ƯU]"], "Môi Se": ["M[ôo]i *Se"], "Áp Ra Ham": ["[ÁA]p *Ra *Ham","ARH[ÂA]m"], "Joseph Smith—Ma Thi Ơ": ["Joseph *Smith—Ma *Thi *[ƠO]", "JS—MT[ƠO]"], "Joseph Smith—Lịch Sử": ["Joseph *Smith—L[ịi]ch *S[ửu]", "JS—LS"], "Những Tín Điều": ["Nh[ữu]ng *T[íi]n *[ĐD]i[ềe]u", "NT[ĐD]"]
            },
            matchRules:{
                book: `(Thứ nhất|I|1|Thứ hai|II|2|Thứ ba|III|3|Thứ tư|IV|4)*\\s*(Sách* của)*\\s*`,
                chapter:"(ch[uư][ơo]ng|[0-9:;,~ —–-])*[0-9]+",
                verse:"đoạn",
                joiners: ["^[;, ]*(hoặc|và|so với)*$",]
        },

    },
    fr:{
        spacing: ["", ""],
        books:{
            "Genèse"	: ["Ge","Gn","Gen","Gen[èe]se"],
            "Exode"	: ["Exo*d*e*"],
            "Lévitique"	: ["L[ée]v*i*"],
            "Nombres"	: ["Nom*(bres)*"],
            "Deutéronome"	: ["Deu*(t[ée]r)*(onome)*"],
            "Josué"	: ["Jos","Josu[ée]"],
            "Juges"	: ["Jg","Jug","Juges"],
            "Ruth"	: ["Ru"],
            "1 Samuel"	: ["1 S","1 Sam*(uel)*"],
            "2 Samuel"	: ["2 S","2 Sam*(uel)*"],
            "1 Rois"	: ["1 R(oi)*s*"],
            "2 Rois"	: ["2 R(oi)*s*"],
            "1 Chroniques"	: ["1 Ch(ron)*(iques)*"],
            "2 Chroniques"	: ["2 Ch(ron)*(iques)*"],
            "Esdras"	: ["Esd*(ras)*"],
            "Néhémie"	: ["Néh*(émie)*"],
            "Esther"	: ["Est*(her)*"],
            "Job"	: ["Jb"],
            "Psaumes"	: ["Ps"],
            "Proverbes"	: ["Pr","Prov"],
            "Ecclésiaste"	: ["Ecc*","Eccl[ée]s*(iaste)*"],
            "Cantique des Cantiques"	: ["Ca","Cantiques*"],
            "Ésaïe"	: ["[EÉ]s","[EÉ]sa[ïi]e"],
            "Jérémie"	: ["J[ée]r*(é)m*(ie)*"],
            "Lamentations"	: ["La","Lam*(entations)*"],
            "Ézéchiel"	: ["[EÉ]z","[EÉ]z[ée]ch*(iel)*"],
            "Daniel"	: ["Dan*"],
            "Osée"	: ["Os([éê]e)*"],
            "Joël"	: ["Jo[ëe]*l*"],
            "Amos"	: ["Am"],
            "Abdias"	: ["Ab"],
            "Jonas"	: ["Jon"],
            "Michée"	: ["Mi","Mich","Mich[ée]e"],
            "Nahum"	: ["Na"],
            "Habacuc"	: ["Hab*"],
            "Sophonie"	: ["So(ph)*"],
            "Aggée"	: ["Ag","Agg[ée]*e"],
            "Zacharie"	: ["Za","Zach"],
            "Malachie"	: ["Mal(ach)*"],
            "Matthieu"	: ["Ma*tt*"],
            "Marc"	: ["Mc","Mar"],
            "Luc"	: ["Lu"],
            "Jean"	: ["Jn"],
            "Actes"	: ["Act*s*"],
            "Romains"	: ["Rom*(ains)*"],
            "1 Corinthiens"	: ["1 Cor*"],
            "2 Corinthiens"	: ["2 Cor*"],
            "Galates"	: ["Gal*"],
            "Éphésiens"	: ["[EÉ]ph*"],
            "Philippiens"	: ["Phi*l"],
            "Colossiens"	: ["Col"],
            "1 Thessaloniciens"	: ["1 Th"],
            "2 Thessaloniciens"	: ["2 Th"],
            "1 Timothée"	: ["1 Tim*(oth[ée]e)*"],
            "2 Timothée"	: ["2 Tim*(oth[ée]e)*"],
            "Tite"	: ["Tit*"],
            "Philémon"	: ["Phm","Phil[ée]mon"],
            "Hébreux"	: ["H[eé]breux"],
            "Jacques"	: ["Ja(c|q)*"],
            "1 Pierre"	: ["1 Pi"],
            "2 Pierre"	: ["2 Pi"],
            "1 Jean"	: ["1 Jn"],
            "2 Jean"	: ["2 Jn"],
            "3 Jean"	: ["3 Jn"],
            "Jude"	: ["Jud"],
            "Apocalypse"	: ["Ap"],
            "1 Néphi"	: ["1 N[eé](phi)*", "1 néphi"],
            "2 Néphi"	: ["2 N[eé](phi)*", "2 néphi"],
            "Jacob"	: ["Jcb"],
            "Énos"	: ["[EÉ]no*s*"],
            "Jarom"	: ["Jm","Jar"],
            "Omni"	: ["Omn*"],
            "Paroles de Mormon"	: ["Pa"],
            "Mosiah"	: ["Mos"],
            "Alma"	: ["Al"],
            "Hélaman"	: ["H[eé]l(aman)*"],
            "3 Néphi"	: ["3 N[eé](phi)*"],
            "4 Néphi"	: ["4 N[eé](phi)*"],
            "Mormon"	: ["Mrm"],
            "Éther"	: ["[EÉ]th*(er)*"],
            "Moroni"	: ["Mo*ro"],
            "Doctrine et Alliances"	: ["D&A"],
            "Moïse"	: ["Mo[iï](se)*"],
            "Abraham"	: ["Abr"],
            "Joseph Smith Matthieu"	: ["JSM"],
            "Joseph Smith Histoire"	: ["JSH"],
            "Articles de foi"	: ["AF"]
         },
         pre_rules: [
            ["Smith[,—–-]+", "Smith"],
            ["JS[,—–-]+ *", "JS"],
            ["le (.*) livre de", "$1"],
            ["(premier|première|1er|1ère)", "1"],
            ["(deuxième|2ème|II)", "2"],
            ["(troisième|3ème|III)", "3"],
            ["(quatrième|4ème|IV)", "4"],
            [",*\\s*(chapitre|ch[.]|section)*\\s*([0-9]+)" , "$2"],
            //["\\s*(:|,|\\.)\\s*(v+[.]*|verset|versets)*\\s*([0-9]*)", "$3"],
         ],
         post_rules: [
            ["Smith (H|M)", "Smith, $1"],
         ],
         matchRules:{
            jst:"JSH",
            book:`(Premier|Première|I|1|1er|1ère|Deuxième|II|2|2ème|Troisième|III|3|3ème|Quatrième|IV|4|4ème)*\\s*(livres* de)*\\s*`,
            verse:"\\s*(:|,|\\.)\\s*(v+[.]*|verset|versets)*\\s*[0-9]*",
            joiners: [
                "^[ ,;]*(et|aussi|voir|voir aussi|v\\. *a\\.)*\\s*:*$",
            ]

         }
    },

    tgl:{
        books:{"Genesis": ["Gen."], "Exodo": ["Ex."], "Levitico": ["Lev."], "Mga Bilang": ["Blg."], "Deuteronomio": ["Deut."], "Josue": ["Jos."], "Mga Hukom": ["Huk."], "Ruth": ["Ruth"], "1 Samuel": ["1 Sam."], "2 Samuel": ["2 Sam."], "1 Mga Hari": ["1 Hari"], "2 Mga Hari": ["2 Hari"], "1 Mga Cronica": ["1 Cron."], "2 Mga Cronica": ["2 Cron."], "Ezra": ["Ezra"], "Nehemias": ["Neh."], "Esther": ["Est."], "Job": ["Job"], "Mga Awit": ["Awit"], "Mga Kawikaan": ["Kaw."], "Eclesiastes": ["Ec."], "Awit ni Solomon": ["A ni S"], "Isaias": ["Is."], "Jeremias": ["Jer."], "Mga Panaghoy": ["Panag."], "Ezekiel": ["Ez."], "Daniel": ["Dan."], "Oseas": ["Os."], "Joel": ["Joel"], "Amos": ["Amos"], "Obadias": ["Obad."], "Jonas": ["Jon."], "Mikas": ["Mi."], "Nahum": ["Nah."], "Habacuc": ["Hab."], "Zefanias": ["Zef."], "Hagai": ["Hag."], "Zacarias": ["Zac."], "Malakias": ["Mal."], "Mateo": ["Mat."], "Marcos": ["Mar."], "Lucas": ["Lu."], "Juan": ["Juan"], "Mga Gawa": ["Gawa"], "Mga Taga-Roma": ["Rom."], "1 Mga Taga-Corinto": ["1 Cor."], "2 Mga Taga-Corinto": ["2 Cor."], "Mga Taga-Galacia": ["Gal."], "Mga Taga-Efeso": ["Ef."], "Mga Taga-Filipos": ["Fil."], "Mga Taga-Colosas": ["Col."], "1 Mga Taga-Tesalonica": ["1 Tes."], "2 Mga Taga-Tesalonica": ["2 Tes."], "1 Kay Timoteo": ["1 Tim."], "2 Kay Timoteo": ["2 Tim."], "Kay Tito": ["Tit."], "Kay Filemon": ["Flm."], "Sa mga Hebreo": ["Heb."], "Santiago": ["Sant."], "1 Pedro": ["1 Ped."], "2 Pedro": ["2 Ped."], "1 Juan": ["1 Juan"], "2 Juan": ["2 Juan"], "3 Juan": ["3 Juan"], "Judas": ["Jud."], "Apocalipsis": ["Apoc."], "1 Nephi": ["1 Ne."], "2 Nephi": ["2 Ne."], "Jacob": ["Jac."], "Enos": ["Enos"], "Jarom": ["Jar."], "Omni": ["Omni"], "Mga Salita ni Mormon": ["S ni M"], "Mosias": ["Mos."], "Alma": ["Alma"], "Helaman": ["Hel."], "3 Nephi": ["3 Ne."], "4 Nephi": ["4 Ne."], "Mormon": ["Morm."], "Eter": ["Eter"], "Moroni": ["Moro."], "Doktrina at mga Tipan": ["D at T"], "Moises": ["Moi."], "Abraham": ["Abr."], "Joseph Smith—Mateo": ["JS—M"], "Joseph Smith—Kasaysayan": ["JS—K"], "Ang mga Saligan ng Pananampalataya": ["S ng P"]}
    },
    jp:{
        books:{
            "創世記": ["創世", "創世記"], "出エジプト記": ["出エ", "出エジプト記"], "レビ記": ["レビ", "レビ記"], "民数記": ["民数", "民数記"], "申命記": ["申命", "申命記"], "ヨシュア記": ["ヨシ", "ヨシュア記"], "士師記": ["士師", "士師記"], "ルツ記": ["ルツ", "ルツ記"], "サムエル記上": ["サ上", "サムエル記上"], "サムエル記下": ["サ下", "サムエル記下"], "列王紀上": ["列上", "列王紀上"], "列王紀下": ["列下", "列王紀下"], "歴代志上": ["歴上", "歴代志上"], "歴代志下": ["歴下", "歴代志下"], "エズラ記": ["エズ", "エズラ記"], "ネヘミヤ記": ["ネヘ", "ネヘミヤ記"], "エステル記": ["エス", "エステル記"], "ヨブ記": ["ヨブ", "ヨブ記"], "詩篇": ["詩篇"], "箴言": ["箴言"], "伝道の書": ["伝道", "伝道の書"], "雅歌": ["雅歌"], "イザヤ書": ["イザ", "イザヤ書"], "エレミヤ書": ["エレ", "エレミヤ書"], "哀歌": ["哀歌"], "エゼキエル書": ["エゼ", "エゼキエル書"], "ダニエル書": ["ダニ", "ダニエル書"], "ホセア書": ["ホセ", "ホセア書"], "ヨエル書": ["ヨエ", "ヨエル書"], "アモス書": ["アモ", "アモス書"], "オバデヤ書": ["オバ", "オバデヤ書"], "ヨナ書": ["ヨナ", "ヨナ書"], "ミカ書": ["ミカ", "ミカ書"], "ナホム書": ["ナホ", "ナホム書"], "ハバクク書": ["ハバ", "ハバクク書"], "ゼパニヤ書": ["ゼパ", "ゼパニヤ書"], "ハガイ書": ["ハガ", "ハガイ書"], "ゼカリヤ書": ["ゼカ", "ゼカリヤ書"], "マラキ書": ["マラ", "マラキ書"], "マタイによる福音書": ["マタ", "マタイによる福音書"], "マルコによる福音書": ["マコ", "マルコによる福音書"], "ルカによる福音書": ["ルカ", "ルカによる福音書"], "ヨハネによる福音書": ["ヨハ", "ヨハネによる福音書"], "使徒行伝": ["使徒", "使徒行伝"], "ローマ人への手紙": ["ロマ", "ローマ人への手紙"], "コリント人への第一の手紙": ["1コリ", "コリント人への第一の手紙"], "コリント人への第二の手紙": ["2コリ", "コリント人への第二の手紙"], "ガラテヤ人への手紙": ["ガラ", "ガラテヤ人への手紙"], "エペソ人への手紙": ["エペ", "エペソ人への手紙"], "ピリピ人への手紙": ["ピリ", "ピリピ人への手紙"], "コロサイ人への手紙": ["コロ", "コロサイ人への手紙"], "テサロニケ人への第一の手紙": ["1テサ", "テサロニケ人への第一の手紙"], "テサロニケ人への第二の手紙": ["2テサ", "テサロニケ人への第二の手紙"], "テモテへの第一の手紙": ["1テモ", "テモテへの第一の手紙"], "テモテへの第二の手紙": ["2テモ", "テモテへの第二の手紙"], "テトスへの手紙": ["テト", "テトスへの手紙"], "ピレモンへの手紙": ["ピレ", "ピレモンへの手紙"], "ヘブル人への手紙": ["ヘブ", "ヘブル人への手紙"], "ヤコブの手紙": ["新ヤコ", "ヤコブの手紙"], "ペテロの第一の手紙": ["1ペテ", "ペテロの第一の手紙"], "ペテロの第二の手紙": ["2ペテ", "ペテロの第二の手紙"], "ヨハネの第一の手紙": ["1ヨハ", "ヨハネの第一の手紙"], "ヨハネの第二の手紙": ["2ヨハ", "ヨハネの第二の手紙"], "ヨハネの第三の手紙": ["3ヨハ", "ヨハネの第三の手紙"], "ユダの手紙": ["ユダ", "ユダの手紙"], "ヨハネの黙示録": ["黙示", "ヨハネの黙示録"], "ニーファイ第一書": ["1ニフ", "ニーファイ第一書"], "ニーファイ第二書": ["2ニフ", "ニーファイ第二書"], "ヤコブ書": ["ヤコ", "ヤコブ書"], "エノス書": ["エノ", "エノス書"], "ジェロム書": ["ジェロ", "ジェロム書"], "オムナイ書": ["オム", "オムナイ書"], "モルモンの言葉": ["モ言", "モルモンの言葉"], "モーサヤ書": ["モサ", "モーサヤ書"], "アルマ書": ["アル", "アルマ書"], "ヒラマン書": ["ヒラ", "ヒラマン書"], "第三ニーファイ": ["3ニフ", "第三ニーファイ"], "第四ニーファイ": ["4ニフ", "第四ニーファイ"], "モルモン書": ["モル", "モルモン書"], "エテル書": ["エテ", "エテル書"], "モロナイ書": ["モロ", "モロナイ書"], "教義と聖約": ["教義", "教義と聖約"], "公式の宣言": ["公式"], "モーセ書": ["モセ", "モーセ書"], "アブラハム書": ["アブ", "アブラハム書"], "ジョセフ・スミス—マタイ": ["ジ—マタ", "ジョセフ・スミス—マタイ"], "ジョセフ・スミス—歴史": ["ジ—歴史", "ジョセフ・スミス—歴史"], "信仰箇条": ["箇条", "信仰箇条"]
        }
    },
    tr: {
        books: {
            // Old Testament
            "Tekvin": ["Tek", "Yaratılış"], 
            "Çıkış": ["Çık"], 
            "Levililer": ["Lev"], 
            "Sayılar": ["Say"], 
            "Tesniye": ["Tes", "Yasa"], 
            "Yeşu": ["Yeş"], 
            "Hakimler": ["Hak"], 
            "Rut": ["Rut"], 
            "1 Samuel": ["1 Sam"], 
            "2 Samuel": ["2 Sam"], 
            "1 Krallar": ["1 Kr"], 
            "2 Krallar": ["2 Kr"], 
            "1 Tarihler": ["1 Tar"], 
            "2 Tarihler": ["2 Tar"], 
            "Ezra": ["Ezr"], 
            "Nehemya": ["Neh"], 
            "Ester": ["Est"], 
            "Eyub": ["Eyü"], 
            "Mezmurlar": ["Mez"], 
            "Süleyman'ın Özdeyişleri": ["Özd", "Sül Öz"], 
            "Vaiz": ["Vaiz"], 
            "Ezgiler Ezgisi": ["Ezg"], 
            "Yeşaya": ["Yeş"], 
            "Yeremya": ["Yer"], 
            "Ağıtlar": ["Ağıt"], 
            "Hezekiel": ["Hez"], 
            "Daniel": ["Dan"], 
            "Hoşea": ["Hoş"], 
            "Yoel": ["Yoel"], 
            "Amos": ["Amos"], 
            "Ovadya": ["Ova"], 
            "Yunus": ["Yun"], 
            "Mika": ["Mika"], 
            "Nahum": ["Nah"], 
            "Habakuk": ["Hab"], 
            "Sefanya": ["Sef"], 
            "Hagay": ["Hag"], 
            "Zekeriya": ["Zek"], 
            "Malaki": ["Mal"], 

            // New Testament
            "Matta": ["Mat"], 
            "Markos": ["Mar"], 
            "Luka": ["Luk"], 
            "Yuhanna": ["Yuh"], 
            "Elçilerin İşleri": ["Elç"], 
            "Romalılar": ["Rom"], 
            "1 Korintliler": ["1 Kor"], 
            "2 Korintliler": ["2 Kor"], 
            "Galatyalılar": ["Gal"], 
            "Efesliler": ["Efes"], 
            "Filipililer": ["Flp"], 
            "Koloseliler": ["Kol"], 
            "1 Selanikliler": ["1 Sel"], 
            "2 Selanikliler": ["2 Sel"], 
            "1 Timoteos": ["1 Tim"], 
            "2 Timoteos": ["2 Tim"], 
            "Titus": ["Tit"], 
            "Filimon": ["Flm"], 
            "İbraniler": ["İbr"], 
            "Yakup": ["Yak"], 
            "1 Petrus": ["1 Pet"], 
            "2 Petrus": ["2 Pet"], 
            "1 Yuhanna": ["1 Yuh"], 
            "2 Yuhanna": ["2 Yuh"], 
            "3 Yuhanna": ["3 Yuh"], 
            "Yahuda": ["Yah"], 
            "Vahiy": ["Vah"], 

            // Additional LDS Scriptures
            "1 Nefi": ["1 Nef"], 
            "2 Nefi": ["2 Nef"], 
            "Yakup": ["Yakup"], 
            "Enos": ["Enos"], 
            "Yarom": ["Yarom"], 
            "Omni": ["Omni"], 
            "Mormon'un Sözleri": ["Mor Söz"], 
            "Mozya": ["Moz"], 
            "Alma": ["Alma"], 
            "Helaman": ["Hel"], 
            "3 Nefi": ["3 Nef"], 
            "4 Nefi": ["4 Nef"], 
            "Mormon": ["Mormon"], 
            "Ether": ["Eter"], 
            "Moroni": ["Moroni"], 
            "Öğreti ve Antlaşmalar": ["Ö&A"], 
            "Musa": ["Mus"], 
            "İbrahim": ["İbra"], 
            "Joseph Smith—Matta": ["JS—Mat"], 
            "Joseph Smith—Tarih": ["JS—Tarih"], 
            "İnanç Makaleleri": ["İM"]
        }
    },
    slv: {
        books: {
            // Old Testament
            "Geneza": ["1 Mz", "Prva Mojzesova knjiga"],
            "Eksodus": ["2 Mz", "Druga Mojzesova knjiga"],
            "Levitik": ["3 Mz", "Tretja Mojzesova knjiga"],
            "Numeri": ["4 Mz", "Četrta Mojzesova knjiga"],
            "Devteronomij": ["5 Mz", "Peta Mojzesova knjiga"],
            "Jozue": ["Joz", "Jozue"],
            "Sodniki": ["Sod", "Sodniki"],
            "Ruta": ["Rut", "Ruta"],
            "1 Samuel": ["1 Sam", "Prva Samuelova knjiga"],
            "2 Samuel": ["2 Sam", "Druga Samuelova knjiga"],
            "1 Kralji": ["1 Kr", "Prva knjiga kraljev"],
            "2 Kralji": ["2 Kr", "Druga knjiga kraljev"],
            "1 Kroniška": ["1 Krn", "Prva kroniška knjiga"],
            "2 Kroniška": ["2 Krn", "Druga kroniška knjiga"],
            "Ezra": ["Ezr", "Ezra"],
            "Nehemija": ["Neh", "Nehemija"],
            "Estera": ["Est", "Estera"],
            "Job": ["Job", "Job"],
            "Psalmi": ["Ps", "Psalmi"],
            "Pregovori": ["Prg", "Pregovori"],
            "Pridigar": ["Prd", "Pridigar", "Kohelet"],
            "Visoka pesem": ["Vp", "Visoka pesem"],
            "Izaija": ["Iz", "Izaija"],
            "Jeremija": ["Jer", "Jeremija"],
            "Žalostinke": ["Žal", "Žalostinke"],
            "Ezekiel": ["Ezk", "Ezekiel"],
            "Daniel": ["Dan", "Daniel"],
            "Ozej": ["Oz", "Ozej"],
            "Joel": ["Jl", "Joel"],
            "Amos": ["Am", "Amos"],
            "Abdija": ["Abd", "Abdija"],
            "Jona": ["Jon", "Jona"],
            "Mihej": ["Mih", "Mihej"],
            "Nahum": ["Nah", "Nahum"],
            "Habakuk": ["Hab", "Habakuk"],
            "Sofonija": ["Sof", "Sofonija"],
            "Agej": ["Ag", "Agej"],
            "Zaharija": ["Zah", "Zaharija"],
            "Malahija": ["Mal", "Malahija"],
    
            // New Testament
            "Matej": ["Mt", "Evangelij po Mateju"],
            "Marko": ["Mr", "Evangelij po Marku"],
            "Luka": ["Lk", "Evangelij po Luku"],
            "Janez": ["Jn", "Evangelij po Janezu"],
            "Apostolska dela": ["Apd", "Apostolska dela"],
            "Rimljani": ["Rim", "Pismo Rimljanom"],
            "1 Korinčanom": ["1 Kor", "Prvo pismo Korinčanom"],
            "2 Korinčanom": ["2 Kor", "Drugo pismo Korinčanom"],
            "Galačanom": ["Gal", "Pismo Galačanom"],
            "Efežanom": ["Ef", "Pismo Efežanom"],
            "Filipljanom": ["Flp", "Pismo Filipljanom"],
            "Kološanom": ["Kol", "Pismo Kološanom"],
            "1 Tesaloničanom": ["1 Tes", "Prvo pismo Tesaloničanom"],
            "2 Tesaloničanom": ["2 Tes", "Drugo pismo Tesaloničanom"],
            "1 Timoteju": ["1 Tim", "Prvo pismo Timoteju"],
            "2 Timoteju": ["2 Tim", "Drugo pismo Timoteju"],
            "Titu": ["Tit", "Pismo Titu"],
            "Filemonu": ["Flm", "Pismo Filemonu"],
            "Hebrejcem": ["Heb", "Pismo Hebrejcem"],
            "Jakobovo": ["Jak", "Jakobovo pismo"],
            "1 Peter": ["1 Pt", "Prvo Petrovo pismo"],
            "2 Peter": ["2 Pt", "Drugo Petrovo pismo"],
            "1 Janez": ["1 Jn", "Prvo Janezovo pismo"],
            "2 Janez": ["2 Jn", "Drugo Janezovo pismo"],
            "3 Janez": ["3 Jn", "Tretje Janezovo pismo"],
            "Juda": ["Jud", "Judovo pismo"],
            "Razodetje": ["Raz", "Razodetje"],
    
            // Additional LDS Scriptures
            "1 Nefi": ["1 Ne", "Prva Nefijeva knjiga"],
            "2 Nefi": ["2 Ne", "Druga Nefijeva knjiga"],
            "Jakob": ["JakK", "Jakobova knjiga"],
            "Enoš": ["En", "Enóševa knjiga"],
            "Jarom": ["Jar", "Jaromova knjiga"],
            "Omni": ["Om", "Omnijeva knjiga"],
            "Mormonove besede": ["MrmB", "Mormonove besede"],
            "Mozija": ["Moz", "Mozijeva knjiga"],
            "Alma": ["Al", "Almova knjiga"],
            "Helaman": ["He", "Helamanova knjiga"],
            "3 Nefi": ["3 Ne", "Tretji Nefi"],
            "4 Nefi": ["4 Ne", "Četrti Nefi"],
            "Mormon": ["Mrm", "Mormonova knjiga"],
            "Eter": ["Etr", "Etrova knjiga"],
            "Moroni": ["Mor", "Moronijeva knjiga"],
            "Nauk in zaveze": ["NaZ", "Nauk in zaveze"],
            "Mojzes": ["Mz", "Mojzesova knjiga"],
            "Abraham": ["Abr", "Abrahamova knjiga"],
            "Joseph Smith — Matej": ["JS – Mt", "Joseph Smith — Evangelij po Mateju"],
            "Joseph Smith — Življenjska zgodba": ["JS – ŽZ", "Joseph Smith — Življenjska zgodba"],
            "Členi vere": ["ČV", "Členi vere"]
        }
    },
    eo: { 
        books: 
        { "Genezo": ["Gen"], "Eliro": ["Eli"], "Levidoj": ["Lev"], "Nombroj": ["Nom"], "Readmono": ["Rea"], "Josuo": ["Jos"], "Juĝistoj": ["Juĝ"], "Rut": ["Rut"], "1 Samuel": ["1 Sam"], "2 Samuel": ["2 Sam"], "1 Reĝoj": ["1 Reĝ"], "2 Reĝoj": ["2 Reĝ"], "1 Kroniko": ["1 Kron"], "2 Kroniko": ["2 Kron"], "Ezra": ["Ezr"], "Neĥemja": ["Neĥ"], "Ester": ["Est"], "Ijob": ["Ijob"], "Psalmaro": ["Ps"], "Sentencoj": ["Sent"], "Predikanto": ["Pred"], "Alt Kanto": ["Alt"], "Jesaja": ["Jes"], "Jeremia": ["Jer"], "Plorkanto": ["Plork"], "Jeĥezkel": ["Jeĥ"], "Daniel": ["Dan"], "Hoŝea": ["Hoŝ"], "Joel": ["Joel"], "Amos": ["Amos"], "Obadja": ["Obad"], "Jona": ["Jon"], "Miĥa": ["Miĥ"], "Naĥum": ["Naĥ"], "Ĥabakuk": ["Ĥab"], "Cefanja": ["Cef"], "Ĥagaj": ["Ĥag"], "Zeĥarja": ["Zeĥ"], "Malaĥi": ["Mal"], "Mateo": ["Mat"], "Marko": ["Mar"], "Luko": ["Luk"], "Johano": ["Joh"], "Agoj": ["Agoj"], "Romanoj": ["Rom"], "1 Korintanoj": ["1 Kor"], "2 Korintanoj": ["2 Kor"], "Galatoj": ["Gal"], "Efesanoj": ["Ef"], "Filipianoj": ["Fil"], "Koloseanoj": ["Kol"], "1 Tesalonikanoj": ["1 Tes"], "2 Tesalonikanoj": ["2 Tes"], "1 Timoteo": ["1 Tim"], "2 Timoteo": ["2 Tim"], "Tito": ["Tit"], "Filemon": ["Fil"], "Hebreoj": ["Heb"], "Jakobo": ["Jak"], "1 Petro": ["1 Pet"], "2 Petro": ["2 Pet"], "1 Johano": ["1 Joh"], "2 Johano": ["2 Joh"], "3 Johano": ["3 Joh"], "Judas": ["Jud"], "Apokalipso": ["Apok"] ,
            // Additional LDS
        "1 Nefi": ["1 Nef"], 
        "2 Nefi": ["2 Nef"], 
        "Jakobo": ["JakK"], 
        "Enos": ["Eno"], 
        "Jerom": ["Jerom"], 
        "Omni": ["Omni"], 
        "La Vortoj de Mormon": ["Vortoj Morm"], 
        "Mosiah": ["Mos"], 
        "Alma": ["Alma"], 
        "Helaman": ["Hel"], 
        "3 Nefi": ["3 Nef"], 
        "4 Nefi": ["4 Nef"], 
        "Mormon": ["Morm"], 
        "Eter": ["Eter"], 
        "Moroni": ["Moroni"], 
        "Doktrino kaj Interligoj": ["D&I"], 
        "Moseo": ["Mos"], 
        "Abraham": ["Abr"], 
        "Joseph Smith—Mateo": ["JS-Mat"], 
        "Joseph Smith—Historio": ["JS-Historio"], 
        "Kredo Artikoloj": ["KA"]

        } 
    }
}
;
const findMatchingBooks = (content,books) => {
    const matchingBooks = books.filter(i=>(new RegExp(i,"ig")).test(content));
    return matchingBooks;
}

const findMatches = (content,books,lang_extra) => {

    const tail = lang_extra.tail ? new RegExp(lang_extra.tail,"ig") : /[^0-9]+$/;
    const preBookMatch = lang_extra.book || `(First|I|1|1st|Second|II|2|2nd|Third|III|3|3rd|Fourth|IV|4|4th)*\\s*(books* of)*\\s*`;
    const matchingBooks = findMatchingBooks(content,books);
    const postBookMatch = lang_extra.chapter || "([0-9:.;,~ —–-]|cf|(?:&ndash;))*[0-9]+";  
const fullBookMatches = matchingBooks.map(bookMatch=>{
        const patternString =  preBookMatch + bookMatch ;
        const pattern = (new RegExp(patternString,"ig"));
        const stringMatch = pattern.test(content) ? patternString : null;
        //console.log({pattern,content,stringMatch});
        return stringMatch;
    }).filter(x=>!!x);

    const bookSubStrings = fullBookMatches.map(bookMatch=>{
        const substrings = content.match(new RegExp(bookMatch,"ig")).flat();
        return substrings;
    }).flat().reduce((prev,current)=>{
        if(prev.includes(current)) return prev;
        return [...prev,current]
    },[]).filter(i=>!!i).map(substring=>{
        substring = substring.trim();
        let positions = [];
        let index = content.indexOf(substring);
        while (index != -1) {
            positions.push(index);
            index = content.indexOf(substring, index + 1);
        }        return [substring,positions];
    }).map(([substring,positions])=>{
        const preChars = positions.map(i=>content.substring(i-1,i));
        positions = positions.filter((i,index)=>{
            const charRightBeforeMatch = preChars[index];
            const leadingCharIsInvalid = !/^(\s|\W|)$/.test(charRightBeforeMatch);  
            return !leadingCharIsInvalid;
        });
        if(!positions.length) return false;
        return [substring,positions];
    }).filter(i=>!!i);

    const possiblyOverlappingMatches = bookSubStrings.map(([substring,positions])=>{
        return positions.map(i=>{
            let pattern = null;
            try{
               pattern = new RegExp(substring+postBookMatch,"ig");
            }catch(e){
                return null;
            }
            const match = content.slice(i).match(pattern)?.[0]?.replace(tail,"").trim();
            if(!match) return null;
            const len = match.length;
            const pos = i;
            const [posIn, posOut] = [pos,pos+len];
            //console.log({content:content.slice(i),pattern,match,posIn,posOut});
            return [match,posIn,posOut];
        }
    )}).flat().filter(i=>!!i);
    const matchesWithReferences = possiblyOverlappingMatches.map(([string,start,end])=>{
        const overLappingItems = possiblyOverlappingMatches.filter(([s,s1,e1])=>s!==string && s1<end && e1>end);
        const hasOverlap = overLappingItems.length > 0;
        const newEnd = hasOverlap ? Math.min(...overLappingItems.map(([s,s1,e1])=>s1)) : end;
        const newString = content.slice(start,newEnd);
        return newString.replace(tail,"").trim();
    }).filter(i=>!!i);
    const matches =  matchesWithReferences.map(string=>{
        const pattern = (new RegExp(string,"ig"));
        const matches = content.match(pattern)?.map(i=>i.trim().replace(tail,""));
        //console.log({string,matches,tail});
        return matches;
    }).flat()
    .reduce((prev,current)=>{
        if(prev.includes(current)) return prev;
        return [...prev,current]
    },[]).filter(i=>!!i);
    return matches;
}



function findMatchIndexes(content, matches,lookupReference, lang_extra) {
    const tail = lang_extra.tail ? new RegExp(lang_extra.tail,"ig") : /[^0-9]+$/;
    const indexes =  matches
    .sort((b, a) => b.length - a.length)
    .map(i=>{
        const length = i.length;
        let positions = [];
        let strPos = content.indexOf(i);

        while (strPos != -1) {
            positions.push(strPos);
            strPos = content.indexOf(i, strPos + 1);
        }
        return positions.map(i=>[i,i+length+2]);
    }).flat()
    .map(a=>{

        const substring = content.substring(a[0],a[1]).trim().replace(tail,"").trim();
        if(!substring) return false;
        const verse_ids = lookupReference(substring).verse_ids;
        //console.log({substring,verse_ids});
        if(verse_ids.length > 0) return [a[0],a[0]+substring.length];

        return false;
    })
    .filter(i=>!!i)
    .sort((a, b) => a[0] - b[0])
    .map(([start, end], index, array) => {
        const nextStart = array[index+1]?.[0] || null;
        end = nextStart ? Math.min(end,nextStart) : end;
        return [start,end];
    });

    if(!indexes.length) return false;


    const tieBreaker = (pair1,pair2)=>{
        const string1 = content.substring(pair1[0],pair1[1]);
        const string2 = content.substring(pair2[0],pair2[1]);

        // if one pair is all lower case, return the other one
        if(/[^A-Z]/.test(string1) && !/[^A-Z]/.test(string2)) return pair2;
        if(/[^A-Z]/.test(string2) && !/[^A-Z]/.test(string1)) return pair1;

        if(string1.length > string2.length) return pair1;
        if(string2.length > string1.length) return pair2;

        return pair1;
    }


    const nonOverlappingIndeces = indexes.reduce((prev, current) => {
        if (prev.length === 0) {
            return [current];
        }
        const lastPair = prev[prev.length - 1];
        if (current[0] < lastPair[1]) { // They overlap
            const chosenPair = tieBreaker(lastPair, current);
            if (chosenPair === lastPair) {
                // Keep the last pair, discard the current one
                return prev;
            } else {
                // Replace the last pair with the current one
                prev.pop();
                return [...prev, current];
            }
        } else {
            // They don't overlap, add the current pair
            return [...prev, current];
        }
    }, []).filter(([start,end])=>start!==end);


    return nonOverlappingIndeces;



}





const processReferenceDetection = (content,books,lang_extra,lookupReference,callback) =>
{
    try{
    lang_extra = lang_extra || {};
    const matches = findMatches(content,books,lang_extra);
    const matchIndeces = findMatchIndexes(content,matches,lookupReference,lang_extra);
    if(!matchIndeces) return content;
    const gapsBetweenIndeces = matchIndeces.reduce((prev,current,index)=>{
        if(index === 0) return prev;
        const lastPair = matchIndeces[index-1];
        const gap = [lastPair[1],current[0]];
        return [...prev,gap];
    },[]);
    const gapStrings = gapsBetweenIndeces.map(([start,end])=>content.substring(start,end).trim());
    //console.log({matches,matchIndeces,gapsBetweenIndeces,gapStrings});
    const joiners = lang_extra?.joiners || ["^[;, ]*(and|c\\.*f\\.*)*$"];
    const gapThatMayBeMerged = gapsBetweenIndeces.map(([start,end],i)=>{
        const gapString = gapStrings[i];
        const canBeMerged =  joiners.some(joiner=>(new RegExp(joiner,"ig")).test(gapString));
        const matchingJoiner = joiners.find(joiner=>(new RegExp(joiner,"ig")).test(gapString));
        //console.log({gapString,matchingJoiner});
        return canBeMerged;
    });


    // new incexes
    const mergedIndeces = matchIndeces.reduce((prev, current, index) => {
        if (index === 0) {
            return [current];
        } else {
            const prevIndex = prev[prev.length - 1];
            if (gapThatMayBeMerged[index - 1]) {
                const merged = [prevIndex[0], current[1]];
                prev[prev.length - 1] = merged;
            } else {
                prev.push(current);
            }
            return prev;
        }
    }, []);

    //get the gaps and the front/end bumpers if any
    const negativeSpace = mergedIndeces.reduce((prev, current, index, array) => {
        if (index !== 0) {
            const prevIndex = array[index - 1];
            const gap = [prevIndex[1], current[0]];
            prev.push(gap);
        }
        return prev;
    }, []);

    if (mergedIndeces[0][0] !== 0) {
        negativeSpace.unshift([0, mergedIndeces[0][0]]);
    }

    if (mergedIndeces[mergedIndeces.length - 1][1] !== content.length) {
        negativeSpace.push([mergedIndeces[mergedIndeces.length - 1][1], content.length]);
    }


    //check content between matches.  If puctuation only (or 'and'), then merge
    const cutItems = mergedIndeces.map(([start,end])=>{
        const string = content.substring(start,end);
        return lookupReference(string).query
    }).map(callback);

   const negativeItems = negativeSpace.map(([start,end])=>content.substring(start,end));
   const firstReferenceIsAtStart = mergedIndeces[0][0] === 0;
   const maxCount = Math.max(cutItems.length,negativeItems.length);
   //merge by alternating cutItems and negativeItems.  run the callback on the cut items
   const merged = [];
   for(let i=0;i<maxCount;i++){
    const firstItem = firstReferenceIsAtStart ? cutItems[i] : negativeItems[i];
    const secondItem = firstReferenceIsAtStart ? negativeItems[i] : cutItems[i];
    if(firstItem) merged.push(firstItem);
    if(secondItem) merged.push(secondItem);
   }

   return merged.join("");
    }catch(e){
        return content;
    }
}
// Browser localStorage key for language preference
const LANGUAGE_STORAGE_KEY = 'scriptureGuideUtils_language';

// Helper function to safely access localStorage
const getStoredLanguage = () => {
    try {
        if (typeof localStorage !== 'undefined') {
            return localStorage.getItem(LANGUAGE_STORAGE_KEY);
        }
    } catch (e) {
        // localStorage might not be available in some environments
    }
    return null;
};

const setStoredLanguage = (language) => {
    try {
        if (typeof localStorage !== 'undefined') {
            if (language) {
                localStorage.setItem(LANGUAGE_STORAGE_KEY, language);
            } else {
                localStorage.removeItem(LANGUAGE_STORAGE_KEY);
            }
        }
    } catch (e) {
        // localStorage might not be available in some environments
    }
};

// Global default language (can be overridden by localStorage)
let defaultLanguage = null;

const setLanguage = function(language) {
    defaultLanguage = language;
    setStoredLanguage(language);
};

const getEffectiveLanguage = function(explicitLanguage) {
    // Priority: explicit parameter > stored language > default language > 'en'
    return explicitLanguage || getStoredLanguage() || defaultLanguage || 'en';
};

const lookupReference = function(query, language = null) {
    const isValidReference = query && typeof query === 'string' && query.length > 0;
    if (!isValidReference) return {
        "query": query,
        "ref": "",
        "verse_ids": []
    };

    // Get effective language (explicit > stored > default > 'en')
    const effectiveLanguage = getEffectiveLanguage(language);
    const config = getLanguageConfig(effectiveLanguage);
    
    //Cleanup
    let ref = cleanReference(query, config);
    //Break compound reference into array of single references
    let refs = splitReferences(ref, config);

    //Lookup each single reference individually, return the set
    let verse_ids = [];
    for (let i in refs) {
        verse_ids = verse_ids.concat(lookupSingleRef(refs[i], config));
    }

    // Fallback to English if no results found and language was specified
    if(!verse_ids?.length && effectiveLanguage && effectiveLanguage !== 'en') {
        const results = lookupReference(query, 'en');
        return results;
    }

    return {
        "query": query,
        "ref": ref,
        "verse_ids": verse_ids
    };
}

const lookupSingleRef = function(ref, config) {
    const booksWithDashRegex = /^(joseph|조셉)/i; // TODO: get from config
    //todo: better handling of multi-book ranges for unicode
    if (!booksWithDashRegex.test(ref) && ref.match(/[—-](\d\s)*[\D]/ig)) return lookupMultiBookRange(ref, config);
    let book = getBook(ref, config);
    if (!book) return [];
    let ranges = getRanges(ref, book);
    let verse_ids = loadVerseIds(book, ranges, config);
    return verse_ids;

}

const validateVerseIds = function(verse_ids) {

    if(!verse_ids) return false;
    if(typeof verse_ids === 'string') verse_ids = verse_ids.split(/[,;]/);
    if(!Array.isArray(verse_ids)) verse_ids = [verse_ids];
    verse_ids = verse_ids.map(v => parseInt(v));
    verse_ids = verse_ids.filter(v => !isNaN(v));
    if(verse_ids.length == 0) return false;
    //if array of non zero integers
    if(verse_ids.filter(v => v > 0).length == verse_ids.length) return verse_ids;
    return false;

}

const generateReference = function(verse_ids, language = null) {

    verse_ids = validateVerseIds(verse_ids);
    if(!verse_ids) return '';

    const effectiveLanguage = getEffectiveLanguage(language);
    const config = getLanguageConfig(effectiveLanguage);
    let ranges = loadVerseStructure(verse_ids, config);
    let refs = loadRefsFromRanges(ranges, config);

    let ref = refs.join("; ");
    return ref;

}


const lookupMultiBookRange = function(cleanRef, config) { //eg Matthew 15—Mark 2

    let range = cleanRef.split(/[—-]/);
    if (!range[0].match(/[:]/)) {
        if (range[0].match(/\d+\s*$/)) range[0] = range[0].trim() + ":" + 1;
        else range[0] = range[0].trim() + " 1:1";
    }
    if (!range[1].match(/[:]/)) {

        let matches = range[1].match(/(.*?)\s(\d+)$/);
        if (matches === null) {
            //find end of book
            let maxChapter = loadMaxChapter(range[1], config);
            let maxverse = loadMaxVerse(range[1], maxChapter, config);
            range[1] = range[1] + " " + maxChapter + ":" + maxverse;
           // console.log(range);
        } else {
            let maxverse = loadMaxVerse(cleanReference(matches[1], config), matches[2], config);
            range[1] = range[1] + ":" + maxverse;
        }
    }
    let start = lookupSingleRef(range[0], config)[0];
    let end = lookupSingleRef(range[1], config)[0];
    let all_verse_ids = [];
    for (let i = start; i <= end; i++) all_verse_ids.push(i);
    return all_verse_ids;
}

const strToHash = function(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = hash * 31 + str.charCodeAt(i);
        //max 32
        if (hash > 2147483647) hash = hash % 2147483647;
    }
    return `==${hash}==`;
}


const cleanReference = function(messyReference, config) {

    let ref = messyReference.replace(/[\s]+/g, " ").trim();

    //Build Regex rules
    let regex = config.raw_regex.pre_rules;
    for (let i in regex) {
        var re = new RegExp(regex[i][0], "ig");
        ref = ref.replace(re, regex[i][1]);
    }

    //Turn dots into colons
    ref = ref.replace(/(\d+)[.](\d+)/g, "$1:$2");
    ref = ref.replace(/[.]/g, "");

    //Treat commas as semicolons in the absence of verses
    //add spaces after semicolons
    ref = ref.replace(/;/g, "; ");
    //add space before numbers
    ref = ref.replace(/^([0-9;,:-]+)(\d+)/g, "$1 $2");
    //spaces around book ranges !!! Breaks vietnamese, which uses dashes (optionally) instead of spaces in book names
    ref = ref.replace(/([–-])(\D+)/g, " $1 $2 ");

    //Handle non-latin languages because \b only works for latin alphabet
    const [wordBreak, buffer] = config.raw_regex.spacing || ["\\b", ""];

    let srcbooks = config.raw_regex.books;
    let dstbooks = buffer ? config.raw_regex.books.map(i => [i[1], i[1]]) : [];
    let bookMatchList = [...dstbooks, ...srcbooks].sort((a, b) => b[0].length - a[0].length);
    regex = bookMatchList;
    let hashCypher = {};
    for (let i in regex) {
        const [,book] = regex[i];
        const hash = strToHash(book);
        hashCypher[book] = hash;
    }
    for (let i in regex) {
        var re = new RegExp( wordBreak + buffer + regex[i][0] + buffer + "\\.*"+wordBreak, "ig");
        let replacement = hashCypher[regex[i][1]] || regex[i][1];
        ref = (buffer+ref+buffer).replace(re, replacement).trim();
    }
    const books = Object.keys(hashCypher);
    const hashes = Object.values(hashCypher);
    ref = ref.replace(new RegExp(hashes.join("|"), "g"), function (match) {
       const bookValue = books[hashes.indexOf((match))];
         return bookValue + " ";
    }
    );


    //Cleanup
    ref = ref.replace(/\s+/g, " "); //remove double spaces
    ref = ref.replace(/\s*[~–-]\s*/g, "-"); //remove spaces around dashes
    ref = ref.replace(/;(\S+)/g, "; $1"); //add space after semicolons

    let cleanReference = ref.trim();

    cleanReference = handleSingleChapterBookRefs(cleanReference, config);
    if (!cleanReference.match(/:/)) cleanReference = cleanReference.replace(/,/, "; ");
    return cleanReference;
}

const handleSingleChapterBookRefs = function(ref, config) {

   const singleChapterBooks = Object.keys(config.raw_index).filter(book => loadMaxChapter(book, config) == 1);
   const [matchingBook] = singleChapterBooks.filter(book => ref.match(new RegExp(`^${book} \\d+`)));
   if(new RegExp(`^${matchingBook} 1:`).test(ref)) return ref;
   if(new RegExp(`^${matchingBook} 1$`).test(ref)) return ref;
   ref = ref.replace(new RegExp(`^${matchingBook} (\\d+)`), `${matchingBook} 1:$1`);
   return ref;
}

const splitReferences = function(compoundReference, config) {
    let refs = compoundReference.split(/\s*;\s*/);
    let runningBook = "";
    let completeRefs = [];
    for (let i in refs) {
        const ref = refs[i];
        let pieces = ref.split(/([0-9:,-]+)$/);
        const firstPiece = pieces[0].trim();
        runningBook = bookExists(firstPiece, config) ? firstPiece : runningBook;
        const needsPreBook = !bookExists(firstPiece, config);
        const preBook = needsPreBook && runningBook ? runningBook : "";
        completeRefs.push((preBook + " " + ref).trim());
    }
    return completeRefs;
}
const getBook = function(ref, config) {
    let book = ref.replace(/([ 0-9:,-]+)$/, '').trim();
    book = book.replace(/-/g, "—");
    if (bookExists(book, config)) return book;
    return false;
}
const getRanges = function(ref) {
    let ranges = [];
    let numbers = ref.replace(/.*?([0-9: ,-]+)$/, '$1').trim();
    numbers=numbers.replace(/^(\d+)-(\d+):(\d+)$/g, '$1:1-$2:$3'); //implict first verse
    let isChaptersOnly = numbers.match(/:/) ? false : true;
    let isRange = !numbers.match(/-/) ? false : true;
    let isSplit = !numbers.match(/,/) ? false : true;
    // Genesis 1,3-5
    if (isChaptersOnly && isSplit && isRange) {
        let chapterRanges = numbers.split(/,/);
        for (let i in chapterRanges) {
            //3-5
            if (chapterRanges[i].match(/-/)) {
                let chapterStartandEnd = chapterRanges[i].split(/-/);
                let startChapter = parseInt(chapterStartandEnd[0], 0);
                let endChapter = parseInt(chapterStartandEnd[1], 0);
                let chapterRange = [];
                for (leti = startChapter; i <= endChapter; i++) {
                    ranges.push(i + ": 1-X");
                }
            }
            //1
            else {
                ranges.push(chapterRanges[i] + ": 1-X");
            }
        }
    }
    // Genesis 1,3
    else if (isChaptersOnly && isSplit) {
        let chapters = numbers.split(/,/);
        ranges = chapters.map(chapter => chapter + ": 1-X");
    }
    //Genesis 1-2 (ch-ch)
    else if (isChaptersOnly && isRange) {
        let chapterStartandEnd = numbers.split(/-/);
        let startChapter = parseInt(chapterStartandEnd[0], 0);
        let endChapter = parseInt(chapterStartandEnd[1], 0);
        let chapterRange = [];
        for (let i = startChapter; i <= endChapter; i++) {
            chapterRange.push(i);
        }
        ranges = chapterRange.map(chapter => chapter + ": 1-X");
    }
    //Genesis 1
    else if (isChaptersOnly) {
        ranges = [numbers + ": 1-X"];
    }
    //Genesis 1:1-5,10   
    else if (isRange && isSplit) {
        let mostRecentChapter = null;
        let split = numbers.split(/,/);
        let chapter = null;
        let verses = null;
        for (let i in split) {
            // 2:2   OR   1:1-4
            if (split[i].match(/:/)) {
                let pieces = split[i].split(/:/);
                chapter = mostRecentChapter = pieces[0];
                verses = pieces[1];
            }
            //3   or 6-7
            else {
                chapter = mostRecentChapter;
                verses = split[i];
            }
            ranges.push(chapter + ": " + verses.trim());
        }
    }
    // Genesis 1:3,5
    else if (isSplit) {
        let split = numbers.split(/,/);
        let mostRecentChapter = null;
        let chapter = null;
        let verses = null;
        for (let i in split) {
            //Genesis 1:1-5
            if (split[i].match(/:/)) {
                let pieces = numbers.split(/:/);
                chapter = mostRecentChapter = pieces[0];
                verses = pieces[1];
            }
            //10
            else {
                chapter = mostRecentChapter;
                verses = split[i];
            }
            ranges.push(chapter + ": " + verses.trim());
        }
    }
    //Genesis 1:1-10 (cv-v)    OR    Exodus 1-2:15 (c-cv)  OR Leviticus 1:10-2:5 (cv-cv)
    else if (isRange) {
        let chapters = numbers.match(/((\d+)[:]|^\d+)/g);
        let verses = numbers.match(/[:-](\d+)/g);
        if (chapters.length == 1) chapters.push(chapters[0]);
        chapters = chapters.map(c => parseInt(c.replace(/\D/g, '').trim()));
        verses = verses.map(v => parseInt(v.replace(/\D/g, '').trim()));
        for (let i = chapters[0]; i <= chapters[1]; i++) {
            let start = 1;
            let end = "X";
            if (chapters[0] == i) start = verses[0];
            if (chapters[1] == i) end = verses[verses.length - 1];
            ranges.push(i + ": " + start + "-" + end);
        }
    } else {
        ranges = [numbers];
    };
    return ranges;
}
const loadVerseIds = function(book, ranges, config) {
    let refIndex = loadRefIndex(config);
    let verseList = [];
    for (let i in ranges) //Assumption: 1 range is within a single chapter
    {
        let range = ranges[i];
        let matches = range.match(/(\d+): *([\dX]+)-*([\dX]*)/);
        if(!matches) continue;
        let chapter = parseInt(matches[1]);
        let start = parseInt(matches[2]);
        let end = matches[3];
        if (end == '') end = start;
        if (end == "X") end = loadMaxVerse(book, chapter, config);
        else end = parseInt(end);
        for (let verse_num = start; verse_num <= end; verse_num++) {
            if (refIndex[book] == undefined) continue;
            if (refIndex[book][chapter] == undefined) continue;
            if (refIndex[book][chapter][verse_num] == undefined) continue;
            verseList.push(refIndex[book][chapter][verse_num]);
        }
    }
    return verseList;
}
const loadVerseStructure = function(verse_ids, config) {
    let verseIdIndex = loadVerseIdIndex(config);
    let segments = consecutiveSplitter(verse_ids);
    let structure = [];
    for (let i in segments) {
        let min = segments[i][0];
        let max = segments[i][segments[i].length - 1];
        structure.push([verseIdIndex[min], verseIdIndex[max]]);
    }
    return structure;
}
const consecutiveSplitter = function(verse_ids) {
    let segments = [];
    let segment = [];
    let previousVerseId = 0;
    for (let i in verse_ids) {
        if (verse_ids[i] != previousVerseId + 1 && previousVerseId != 0) {
            segments.push(segment);
            segment = [];
        }
        segment.push(verse_ids[i]);
        previousVerseId = verse_ids[i];
    }
    segments.push(segment);
    return segments;
}
const loadRefsFromRanges = function(ranges, config) {
    let refs = [];
    let mostRecentBook, mostRecentChapter;
    for (let i in ranges) {
        let ref = '';
        let start_bk = ranges[i][0][0];
        let end_bk = ranges[i][1][0];
        let start_ch = ranges[i][0][1];
        let end_ch = ranges[i][1][1];
        let start_vs = ranges[i][0][2];
        let end_vs = ranges[i][1][2];
        if (start_bk == end_bk) {
            if (start_ch == end_ch) {
                if (start_bk == mostRecentBook) start_bk = '';
                if (start_bk == mostRecentBook && start_ch == mostRecentChapter) start_ch = '';
                if (start_vs == end_vs) {
                    ref = start_bk + " " + start_ch + ":" + start_vs;
                } else {
                    if (start_vs == 1 && end_vs == loadMaxVerse(start_bk, start_ch, config)) //whole chapter
                    {
                        ref = start_bk + " " + start_ch;
                    } else {
                        ref = start_bk + " " + start_ch + ":" + start_vs + "-" + end_vs;
                    }
                }
            } else {
                if (start_vs == 1 && end_vs == loadMaxVerse(end_bk, end_ch, config)) {
                    ref = start_bk + " " + start_ch + "-" + end_ch;
                } else {
                    ref = start_bk + " " + start_ch + ":" + start_vs + "-" + end_ch + ":" + end_vs;
                }
            }
        } else {
            if (start_vs == 1 && end_vs == loadMaxVerse(end_bk, end_ch, config)) {
                ref = start_bk + " " + start_ch + " - " + end_bk + " " + end_ch;
            } else if (end_vs == loadMaxVerse(end_bk, end_ch, config)) {
                ref = start_bk + " " + start_ch + ":" + start_vs + " - " + end_bk + " " + end_ch;
            } else if (start_vs == 1) {
                ref = start_bk + " " + start_ch + " - " + end_bk + " " + end_ch + ":" + end_vs;
            } else {
                ref = start_bk + " " + start_ch + ":" + start_vs + " - " + end_bk + " " + end_ch + ":" + end_vs;
            }
        }
        if (start_bk != '') mostRecentBook = start_bk;
        if (start_ch != '') mostRecentChapter = start_ch;
        ref = ref.replace(/^\s+:*/, '').trim();
        
        // Apply language-specific post rules
        if (config.raw_regex.post_rules) {
            for (let rule of config.raw_regex.post_rules) {
                const re = new RegExp(rule[0], "ig");
                ref = ref.replace(re, rule[1]);
            }
        }
        
        refs.push(ref);
    }
    return refs;
}

const loadRefIndex = function(config) {
    let refIndex = {};
    let verse_id = 1;
    let book_list = Object.keys(config.raw_index);
    for (let a in book_list) {
        let book_title = book_list[a];
        refIndex[book_title] = {};
        for (let b in config.raw_index[book_title]) {
            let chapter_num = parseInt(b) + 1;
            let verse_max = config.raw_index[book_title][b];
            refIndex[book_title][chapter_num] = {};
            for (var verse_num = 1; verse_num <= verse_max; verse_num++) {
                refIndex[book_title][chapter_num][verse_num] = verse_id;
                verse_id++;
            }
        }
    }
    return refIndex;
}


const loadVerseIdIndex = function(config) {
    let verseIdIndex = [null];
    let book_list = Object.keys(config.raw_index);
    for (let a in book_list) {
        let book_title = book_list[a];
        for (let b in config.raw_index[book_title]) {
            let chapter_num = parseInt(b) + 1;
            let verse_max = config.raw_index[book_title][b];
            for (var verse_num = 1; verse_num <= verse_max; verse_num++) {
                verseIdIndex.push([book_title, chapter_num, verse_num]);
            }
        }
    }
    return verseIdIndex;
}


const bookExists = function(book, config) {
    if (config.raw_index[book] === undefined) return false;
    return true;
}


const loadMaxChapter = function(book, config) {

    if (!bookExists(book, config)) return 0;
    return config.raw_index[book].length;
}

const loadMaxVerse = function(book, chapter, config) {

    if (!bookExists(book, config)) return 0;
    return config.raw_index[book][parseInt(chapter) - 1]
}



const detectReferences = (content, callBack, language = null) => {

    callBack = callBack ? callBack : (i)=>{return `[${i}]`};
    const effectiveLanguage = getEffectiveLanguage(language);
    const config = getLanguageConfig(effectiveLanguage);
    const src = config.raw_regex.books.map(i => i[0]);
    const dst = [...new Set(config.raw_regex.books.map(i => i[1]))];
    const books = [...dst, ...src];
    return processReferenceDetection(content, books, config.lang_extra, (query) => lookupReference(query, effectiveLanguage), callBack);

}

const getLanguageConfig = function(language) {
    // Default to English if no language specified or not found
    const effectiveLanguage = language && raw_lang[language] ? language : 'en';
    
    const config = {
        language: effectiveLanguage,
        raw_index: raw_index_orig,
        raw_regex: {...raw_regex_orig},
        lang_extra: {},
        wordBreak: "\\b"
    };

    // For English or if language not found, use defaults
    if (effectiveLanguage === 'en' || !raw_lang[effectiveLanguage]) {
        return config;
    }

    // Process language-specific data
    const langData = raw_lang[effectiveLanguage];
    
    if(langData.books) {
        config.raw_regex.books = [];
        let new_index = {};
        const bookList = Object.keys(langData.books);
        for(let book of bookList) {
            const book_index = bookList.indexOf(book);
            const original_bookname = Object.keys(raw_index_orig)?.[book_index];
            if (original_bookname) {
                new_index[book] = raw_index_orig[original_bookname];
            }
            const matches = [book, ...langData.books[book]];
            config.raw_regex.books = config.raw_regex.books.concat(matches.map(i => [i, book]));
        }
        config.raw_index = new_index;
    }

    config.raw_regex.pre_rules = langData.pre_rules || config.raw_regex.pre_rules;
    config.raw_regex.post_rules = langData.post_rules || config.raw_regex.post_rules;
    config.raw_regex.spacing = langData.spacing || ["\\b", ""];
    config.lang_extra = langData.matchRules || {};
    config.wordBreak = langData.wordBreak || "\\b";

    return config;
}


export {
    lookupReference,
    generateReference,
    setLanguage,
    detectReferences,

    //Aliases for convenience
    setLanguage as lang,
    setLanguage as language,
    setLanguage as setLang,

    lookupReference as lookup,
    lookupReference as parse,
    lookupReference as read,
    lookupReference as ref2VerseId,

    generateReference as ref,
    generateReference as gen,
    generateReference as generate,
    generateReference as verseId2Ref,

    detectReferences as detect,
    detectReferences as detectScriptureReferences,
    detectReferences as detectRefs,
    detectReferences as detectScriptures,
    detectReferences as linkRefs,
};